(self.webpackChunkopentezos=self.webpackChunkopentezos||[]).push([[994],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),d=r,h=m["".concat(l,".").concat(d)]||m[d]||u[d]||i;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8860:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return s},toc:function(){return l},default:function(){return p}});var a=n(2122),r=n(9756),i=(n(7294),n(3905)),o={id:"unit-testing",title:"Unit Testing with PyTezos",authors:"Maxime Sallerin and Benjamin Pilia"},s={unversionedId:"ligo/unit-testing",id:"ligo/unit-testing",isDocsHomePage:!1,title:"Unit Testing with PyTezos",description:"There are multiple frameworks for testing Michelson contracts:",source:"@site/docs/ligo/unit-testing.md",sourceDirName:"ligo",slug:"/ligo/unit-testing",permalink:"/ligo/unit-testing",editUrl:"https://github.com/octo-technology/OpenTezos/tree/main/docs/ligo/unit-testing.md",version:"current",lastUpdatedBy:"Theotime-Akeare",lastUpdatedAt:1622538450,formattedLastUpdatedAt:"6/1/2021",frontMatter:{id:"unit-testing",title:"Unit Testing with PyTezos",authors:"Maxime Sallerin and Benjamin Pilia"},sidebar:"docs",previous:{title:"Smart Contract",permalink:"/ligo/deploy-a-contract"},next:{title:"Examples",permalink:"/ligo/examples"}},l=[{value:"Unit Testing",id:"unit-testing",children:[]},{value:"PyTezos Installation",id:"pytezos-installation",children:[{value:"Requirement",id:"requirement",children:[]},{value:"Installation",id:"installation",children:[]}]},{value:"Unittest (Python library)",id:"unittest-python-library",children:[]},{value:"Testing a compiled smart contract with PyTezos",id:"testing-a-compiled-smart-contract-with-pytezos",children:[{value:"Equivalence between michelson types and python",id:"equivalence-between-michelson-types-and-python",children:[]},{value:"Counter Contract Example",id:"counter-contract-example",children:[]}]}],c={toc:l};function p(e){var t=e.components,o=(0,r.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,a.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"There are multiple frameworks for testing Michelson contracts:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://pytezos.org/"},"PyTezos")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://gitlab.com/morley-framework/morley/-/blob/9455cd384b2ab897fb7b31822abca3730a4ad08b/code/cleveland/testingEDSL.md"},"Cleveland"))),(0,i.kt)("p",null,"Another alternative is to use Tezos's binary ",(0,i.kt)("inlineCode",{parentName:"p"},"tezos-client")," directly.\nOr there's also a new ",(0,i.kt)("a",{parentName:"p",href:"https://tezos.gitlab.io/user/mockup.html"},"mockup")," mode that no longer requires a Tezos node to run."),(0,i.kt)("p",null,"This chapter aims to introduce the concept of unit testing\nand especially, how to deal with testing Tezos smart contract using the ",(0,i.kt)("a",{parentName:"p",href:"https://pytezos.org/"},"PyTezos")," python framework."),(0,i.kt)("h2",{id:"unit-testing"},"Unit Testing"),(0,i.kt)("p",null,"Just like any other programming language, writing Ligo code (for it, to be compiled into Michelson) is not the only task of a developer:\nwriting the tests is as important as writing the code."),(0,i.kt)("p",null,"Writing a test may take extra time, but this effort is usually rewarded by some great benefits:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"a test helps to understand the code: a user or a new developer can easily understand the code behaviour through testing.\nThe test name should clearly describe what the code is checking;\nthe test itself shows how the code should be handled."),(0,i.kt)("li",{parentName:"ul"},"checking the good behaviour of the written code. It is a benefit to both the developer and the user of a smart contract:\nboth of them want to be sure the smart contract behaves as it should"),(0,i.kt)("li",{parentName:"ul"},"It also makes the code robust for future modifications,\ni.e. code refactoring or new functionalities.\nThe tests make sure that the behaviour has not changed, and if it did, it will clearly outline where."),(0,i.kt)("li",{parentName:"ul"},"tests can easily be automated: they can be included in a CI/CD, which will run them after any push")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"CI/CD (Continuous Integration / Continuous Delivery)")," is a method to frequently deliver apps to customers by introducing automation into the stages of app development.",(0,i.kt)("br",{parentName:"p"}),"\n","The main concepts attributed to CI/CD are continuous integration, continuous delivery, and continuous deployment.")),(0,i.kt)("p",null,"There are different types of tests, as described below in the automated testing strategy."),(0,i.kt)("br",null),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(4926).Z})),(0,i.kt)("small",{className:"figure"},"FIGURE 1: Pyramide of Tests"),(0,i.kt)("p",null,"Unit tests are the base of the pyramid and therefore the most important part."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Unit testing")," is performed at a very fine granularity\nby fully verifying the behaviour of a portion of code",(0,i.kt)("br",{parentName:"p"}),"\n","or by partially isolating it from its dependencies.\nIt will then be simpler to write and maintain. While an integration test aims to verify that several components work well together."),(0,i.kt)("p",null,"To go further, take a look at ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Test-driven_development"},"Test-Driven Development (TDD)")," which is a development method emphasizing\nthe writing of automated tests as a tool to guide the implementation of features."),(0,i.kt)("p",null,"Ligo does not provide a testing framework. But other languages, such as Python, do.\nThis chapter details how to write Michelson code unit tests in Python.\nTwo modules are needed:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the standard ",(0,i.kt)("em",{parentName:"li"},"unittest")," module: used to write and run unit tests in Python"),(0,i.kt)("li",{parentName:"ul"},"the ",(0,i.kt)("em",{parentName:"li"},"pytezos")," module: used to call the entrypoints of a smart contract, without deploying the smart contract.\nThis module is an interesting option because it is well-maintained and easy to use.\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"The execution time or CPU time")," of a given task is defined as the time spent by the system executing that task.",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("strong",{parentName:"p"},"Cost")," can be seen as the complexity and time required for the developer to write a test.")),(0,i.kt)("h2",{id:"pytezos-installation"},"PyTezos Installation"),(0,i.kt)("h3",{id:"requirement"},"Requirement"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Python 3"),(0,i.kt)("li",{parentName:"ul"},"Text editor"),(0,i.kt)("li",{parentName:"ul"},"Cryptographic dependencies, detailed here ",(0,i.kt)("a",{parentName:"li",href:"https://pytezos.org/quick_start.html#requirements"},"link"),".")),(0,i.kt)("h3",{id:"installation"},"Installation"),(0,i.kt)("h4",{id:"creation-of-a-virtual-environment"},"Creation of a virtual environment"),(0,i.kt)("p",null,"A virtual environment is a self-contained Python installation, separated from the global Python installation.\nIt contains its own modules. Hence, it is most useful when a specific version of a module is needed, without affecting the other modules.\nRun this command to create a virtual environment:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"python3 -m venv /path/to/env\n")),(0,i.kt)("h4",{id:"activating-the-environment"},"Activating the environment"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"source /path/to/env/bin/activate\n")),(0,i.kt)("h4",{id:"installation-of-the-necessary-python-libraries"},"Installation of the necessary python libraries"),(0,i.kt)("p",null,"Installation of ",(0,i.kt)("strong",{parentName:"p"},"PyTezos"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"(venv) pip install pytezos\n")),(0,i.kt)("p",null,"Verification of the installation:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'(venv) python -c "import pytezos"\n')),(0,i.kt)("p",null,"If the command returns nothing then the installation is successful."),(0,i.kt)("p",null,"You can find the official documentation here ",(0,i.kt)("a",{parentName:"p",href:"https://pytezos.org/"},"https://pytezos.org/")," and\nall the versions on the project's Github ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/baking-bad/pytezos"},"https://github.com/baking-bad/pytezos")," in the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/baking-bad/pytezos/releases"},"Releases part"),"."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"The pytezos version used for the following example is ",(0,i.kt)("inlineCode",{parentName:"p"},"pytezos==3.1.0"),".",(0,i.kt)("br",{parentName:"p"}),"\n","You can check the version of your package with the ",(0,i.kt)("inlineCode",{parentName:"p"},"pip freeze")," command.",(0,i.kt)("br",{parentName:"p"}),"\n","You can install a specific version if needed with ",(0,i.kt)("inlineCode",{parentName:"p"},"pip install pytezos=={pytezos_version}"),".")),(0,i.kt)("h2",{id:"unittest-python-library"},"Unittest (Python library)"),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"Unittest")," is the standard unit testing framework for Python.\nBefore writing a test for smart contracts with ",(0,i.kt)("strong",{parentName:"p"},"PyTezos"),",\nyou need to know how to use the test library."),(0,i.kt)("p",null,"Let's see how ",(0,i.kt)("strong",{parentName:"p"},"Unittest")," works through a simple example."),(0,i.kt)("p",null,"Consider a python file ",(0,i.kt)("inlineCode",{parentName:"p"},"calculator.py")," with two functions: ",(0,i.kt)("inlineCode",{parentName:"p"},"multiply")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"divide")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"#calculator.py\n\ndef multiply(x, y):\n    return x * y\n\n\ndef divide(x, y):\n    if y != 0:\n        return x / y\n")),(0,i.kt)("p",null,"In order to test these two functions\nlet's create a new test file beginning by ",(0,i.kt)("strong",{parentName:"p"},"test_")," : ",(0,i.kt)("inlineCode",{parentName:"p"},"test_calculator.py"),"."),(0,i.kt)("p",null,"In this file you will need to:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"import the unittest module")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"import unittest\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"import the file you want with the functions you want to test: ",(0,i.kt)("inlineCode",{parentName:"li"},"import calculator"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"import unittest\n\nimport calculator\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Create a test class that inherits from ",(0,i.kt)("inlineCode",{parentName:"li"},"unittest.TestCase"),".",(0,i.kt)("br",{parentName:"li"}),"You can name this class whatever you want but try to keep it descriptive.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"import unittest\nfrom unittestExample import calculator\n\nclass TestCalculator(unittest.TestCase):\n  pass #keyword which tells the class to do nothing\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Write your tests. Keep in mind these few basic rules:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"A test must check only one behaviour at a time."),(0,i.kt)("li",{parentName:"ul"},"One test = one method"),(0,i.kt)("li",{parentName:"ul"},"No magic number: all the values used must be declared in variables, with explicit names"),(0,i.kt)("li",{parentName:"ul"},"There can be no useless variables to pass the test. If a variable can be removed without making the test fail, it must be removed."),(0,i.kt)("li",{parentName:"ul"},"The method name must be explicit. Anyone should understand what the test takes as input, what behaviour is been checked and what result is expected."),(0,i.kt)("li",{parentName:"ul"},"A test can be divided into three parts (as implemented in the tests below):",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"GIVEN section: input declarations, expected results"),(0,i.kt)("li",{parentName:"ul"},"WHEN section: the tested method is called with the declared inputs"),(0,i.kt)("li",{parentName:"ul"},"THEN: assertions checks")))))),(0,i.kt)("p",null,"With unittest, a test method must include ",(0,i.kt)("inlineCode",{parentName:"p"},"test_")," otherwise it will not be considered as a test."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"class TestCalculator(unittest.TestCase):\n\n  def test_multiplying_10_and_5_should_return_(self):\n    # GIVEN\n    x = 10\n    y = 5\n    expected_multiplication_result = 50\n    # WHEN\n    result = calculator.multiply(x, y)\n\n    # THEN\n    self.assertEqual(result, expected_multiplication_result)\n\n  def test_dividing_7_and_3_should_return_a_floating_number_2_33333333(self):\n    # GIVEN\n    x = 7\n    y = 3\n    expected_division_result = 2.3333333333333335\n\n    # WHEN\n    result = calculator.divide(x, y)\n\n    # THEN\n    self.assertEqual(result, expected_division_result)\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"At the beginning of this chapter, several of the benefits of unit testing were raised.\nThis simple tests-suite gives a good example:"),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},"Reading the test name gives a clear idea about its code implementation.\nFor instance, the second test shows that it is not a Euclidean division been implemented"),(0,i.kt)("li",{parentName:"ul"},"The dividng method could be the Euclidean division. The test checks that it returns, is a float number and not an int.\nIf another developer was to change it into a Euclidean division, the test would fail and instantly warn the developer of a breaking change"))),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Note that class names are by convention in ",(0,i.kt)("strong",{parentName:"p"},"CamelCase"),"\nand test method names are in ",(0,i.kt)("strong",{parentName:"p"},"snake_case"),".")),(0,i.kt)("p",null,"You can run your tests in the command line as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"python -m unittest test_calculator\n")),(0,i.kt)("p",null,"This should return:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"..\n----------------------------------------------------------------------\nRan 2 tests in 0.002s\n\nOK\n")),(0,i.kt)("p",null,"Note that the command has executed all the tests in the ",(0,i.kt)("inlineCode",{parentName:"p"},"test_calculator.py")," file,\nbut that it is only possible to execute some specific tests."),(0,i.kt)("p",null,"Indeed, the unittest module can be used from the command line to execute tests from modules,\nclasses or even individual test methods:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"python -m unittest test_calculator\npython -m unittest test_calculator.TestCalculator\npython -m unittest test_calculator.TestCalculator.test_sub\n")),(0,i.kt)("h2",{id:"testing-a-compiled-smart-contract-with-pytezos"},"Testing a compiled smart contract with PyTezos"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"PyTezos")," library is a ",(0,i.kt)("strong",{parentName:"p"},"Python")," toolset for the ",(0,i.kt)("strong",{parentName:"p"},"Tezos")," blockchain,\nit includes work with keys, signatures, contracts, operations, RPC query builder,\nand a high-level interface for smart contract interaction."),(0,i.kt)("p",null,"This module is very interesting for testing smart-contracts unit:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"it can directly test the Michelson code with a Python script, without having to deploy it on a testnet."),(0,i.kt)("li",{parentName:"ul"},"since it does not have to wait for transactions confirmations, the tests are fast to run"),(0,i.kt)("li",{parentName:"ul"},"it can simulate any execution context (sender, amount, storage...)"),(0,i.kt)("li",{parentName:"ul"},"it gives total control over the storage: each test has its own initial storage, and the output storage can be checked."),(0,i.kt)("li",{parentName:"ul"},"the tests are independent one from another. If the tests were run on a deployed smart contract, the initial storage of a test would be the output storage of the previous one.")),(0,i.kt)("p",null,"In this section, we will test the entrypoints of a michelson script\nfor a smart contract that is compiled but not deployed."),(0,i.kt)("p",null,"For this we will need:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("strong",{parentName:"li"},"Unittest")," library, which is the standard framework for writing tests in Python."),(0,i.kt)("li",{parentName:"ul"},"Two very useful classes from ",(0,i.kt)("strong",{parentName:"li"},"PyTezos"),":",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"ContractInterface"),": allows interfacing with the entrypoints of a contract\nand interact with them."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"MichelsonRuntimeError"),": allows handling errors raised during execution.")))),(0,i.kt)("p",null,"To write the tests we will use the following template:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'# TEMPLATE\nfrom unittest import TestCase, skip\nfrom pytezos import MichelsonRuntimeError, ContractInterface\n\npath_to_michelson_contract = "/path/to/contract.tz"\n\n\nclass TestContract(TestCase):\n\n  @classmethod\n  def setUpClass(cls):\n    cls.myContract = ContractInterface.create_from(path_to_michelson_contract)\n\n  def test_description_1(self):\n    pass\n\n  def test_description_2(self):\n    pass\n\n  @skip("test 3 is not launched")\n  def test_description_3(self):\n    pass\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"PyTezos")," requires the path to a file containing Michelson code ",(0,i.kt)("inlineCode",{parentName:"p"},"path_to_michelson_contract"),"."),(0,i.kt)("p",null,"The compiled contract is obtained through a command of this type:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"ligo compile-contract file.ligo main > contract.tz\n")),(0,i.kt)("p",null,"Remember to recompile after any modification of the contract."),(0,i.kt)("h3",{id:"equivalence-between-michelson-types-and-python"},"Equivalence between michelson types and python"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"PyTezos")," allows you to interpret michelson code, here are the equivalences:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:"center"},"Michelson"),(0,i.kt)("th",{parentName:"tr",align:"center"},"Python"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"center"},"List, Set"),(0,i.kt)("td",{parentName:"tr",align:"center"},"[]")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"center"},"Big_map"),(0,i.kt)("td",{parentName:"tr",align:"center"},"()")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"center"},"String"),(0,i.kt)("td",{parentName:"tr",align:"center"},"String")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"center"},"Number"),(0,i.kt)("td",{parentName:"tr",align:"center"},"Integer")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"center"},"mutez, tez"),(0,i.kt)("td",{parentName:"tr",align:"center"},"Interpreted as Integer by ",(0,i.kt)("inlineCode",{parentName:"td"},".interpret()"))))),(0,i.kt)("p",null,"For example if you want to check the content of a list in the storage you would write:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"self.assertEqual(my_list_from_the_storage, [expected_value1, expected_value2, ...])\n")),(0,i.kt)("p",null,"The way to get ",(0,i.kt)("inlineCode",{parentName:"p"},"my_list_from_the_storage")," is detailed below in the examples."),(0,i.kt)("h3",{id:"counter-contract-example"},"Counter Contract Example"),(0,i.kt)("p",null,"Here is an example of a ",(0,i.kt)("strong",{parentName:"p"},"Counter contract"),' that handles an integer of "counter" value, an administrator address\nas storage and allows the administrator ',(0,i.kt)("strong",{parentName:"p"},"only")," to increment or decrement this counter."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'type indiceStorage is record[\n    counter : int;\n    administrator : address;\n]\n\ntype indiceEntrypoints is Increment of int | Decrement of int\n\ntype indiceFullReturn is list(operation) * indiceStorage\n\nfunction increment(const param : int; const s : indiceStorage) : indiceFullReturn is\nif Tezos.source =/= s.administrator then  (failwith("administrator not recognized") : indiceFullReturn)\n    else ((nil : list (operation)), s with record [counter=s.counter + param])\n\nfunction decrement(const param : int; const s : indiceStorage) : indiceFullReturn is\nif Tezos.source =/= s.administrator then  (failwith("administrator not recognized") : indiceFullReturn)\n    else ((nil : list (operation)), s with record [counter=s.counter - param])\n    \nfunction main(const ep : indiceEntrypoints; const store : indiceStorage) : indiceFullReturn is\nblock {\n    const ret : indiceFullReturn = case ep of\n    | Increment(p) -> increment(p, store)\n    | Decrement(p) -> decrement(p, store)\n    end;\n} with ret\n')),(0,i.kt)("p",null,"Let's compile this contract and save the result in a Michelson file ",(0,i.kt)("inlineCode",{parentName:"p"},"counter.tz"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"ligo compile-contract counter.ligo main > counter.tz\n")),(0,i.kt)("p",null,"The output is :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{ parameter (or (int %decrement) (int %increment)) ;\n  storage (pair (address %administrator) (int %counter)) ;\n  code { UNPAIR ;\n         IF_LEFT\n           { SWAP ;\n             DUP ;\n             DUG 2 ;\n             CAR ;\n             SOURCE ;\n             COMPARE ;\n             NEQ ;\n             IF { DROP 2 ; PUSH string "administrator not recognized" ; FAILWITH }\n                { SWAP ;\n                  DUP ;\n                  DUG 2 ;\n                  CDR ;\n                  SUB ;\n                  SWAP ;\n                  CAR ;\n                  PAIR ;\n                  NIL operation ;\n                  PAIR } }\n           { SWAP ;\n             DUP ;\n             DUG 2 ;\n             CAR ;\n             SOURCE ;\n             COMPARE ;\n             NEQ ;\n             IF { DROP 2 ; PUSH string "administrator not recognized" ; FAILWITH }\n                { SWAP ;\n                  DUP ;\n                  DUG 2 ;\n                  CDR ;\n                  ADD ;\n                  SWAP ;\n                  CAR ;\n                  PAIR ;\n                  NIL operation ;\n                  PAIR } } } }\n')),(0,i.kt)("p",null,"First, let's test the ",(0,i.kt)("strong",{parentName:"p"},"increment")," entrypoint if the user is the administrator."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Note that only the administrator is allowed to modify the storage and if another person tries to do it\nthen the contract will return an error."),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},'if Tezos.source =/= s.administrator then  (failwith("administrator not recognized") : indiceFullReturn)\n'))),(0,i.kt)("h4",{id:"test-increment-entrypoint"},"Test increment entrypoint"),(0,i.kt)("p",null,"For example, let's write a test that verifies that the storage is incremented by 5\nwhen the administrator performs the ",(0,i.kt)("inlineCode",{parentName:"p"},"Increment(5)")," action."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For the test a false address tz1 has been assigned to the administrator,\nyou can generate a false address ",(0,i.kt)("a",{parentName:"li",href:"https://faucet.tzalpha.net/"},"here"),"."),(0,i.kt)("li",{parentName:"ul"},"In the ",(0,i.kt)("inlineCode",{parentName:"li"},"setUpClass")," method we load the contract from the michelson source-code, stored in the ",(0,i.kt)("strong",{parentName:"li"},"counter.tz")," file,\nwith the ",(0,i.kt)("inlineCode",{parentName:"li"},"ContractInterface.from_file()")," method."),(0,i.kt)("li",{parentName:"ul"},"Note that the name of the test accurately describes the test's intention.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from unittest import TestCase\nfrom pytezos import MichelsonRuntimeError, ContractInterface\n\npath_to_michelson_contract = "counter.tz"\nadministrator = "tz1L738ifd66ah69PrmKAZzckvvHnbcSeqjf"\n\n\nclass TestCounterContract(TestCase):\n\n    @classmethod\n    def setUpClass(cls):\n        cls.counterContract = ContractInterface.from_file(path_to_michelson_contract)\n\n    def test_storage_counter_is_incremented_by_5_if_the_source_is_the_administrator(self):\n        # GIVEN\n        storage = {"administrator": administrator, "counter": 0}\n        value = 5\n\n        # WHEN\n        result = self.counterContract.increment(value).interpret(storage=storage, source=administrator)\n\n        # THEN\n        self.assertEqual(result.storage["counter"], 5)\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"GIVEN")," "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"That the storage has been initialized as a dictionary ",(0,i.kt)("inlineCode",{parentName:"li"},"{}"),"\nto respect the equivalence with the michelson format. "),(0,i.kt)("li",{parentName:"ul"},"The incremented value is an ",(0,i.kt)("inlineCode",{parentName:"li"},"int"),".")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"WHEN")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"From our contract ",(0,i.kt)("inlineCode",{parentName:"li"},"self.counterContract")," we can call an ",(0,i.kt)("strong",{parentName:"li"},"entrypoint")," and its ",(0,i.kt)("strong",{parentName:"li"},"parameter")," with ",(0,i.kt)("inlineCode",{parentName:"li"},".increment(value)"),"."),(0,i.kt)("li",{parentName:"ul"},"Then we can add a context with ",(0,i.kt)("inlineCode",{parentName:"li"},".interpret()"),".\nto specify the storage and the source (the original address that is sending the transaction).")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"THEN"),(0,i.kt)("br",{parentName:"p"}),"\n","Finally we can check that the storage counter has been incremented by 5\nwith ",(0,i.kt)("inlineCode",{parentName:"p"},"self.assertEqual(<actual_value>, <expected_value>)"),"."),(0,i.kt)("p",null,"Let's run the test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"python -m unittest test_counter.TestCounterContract.test_storage_counter_is_incremented_by_5_if_the_source_is_the_administrator\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"----------------------------------------------------------------------\nRan 1 test in 0.011s\n\nOK\n\n")),(0,i.kt)("p",null,"Great, it worked!"),(0,i.kt)("h4",{id:"test-unauthorized-user-michelsonruntimeerror"},"Test unauthorized user (MichelsonRuntimeError)"),(0,i.kt)("p",null,"Now let's imagine that someone other than the administrator\ntries to modify the storage by incrementing or decrementing it."),(0,i.kt)("p",null,"Let's write a test to make sure that this user gets rejected."),(0,i.kt)("p",null,"First, let's add a new user ",(0,i.kt)("strong",{parentName:"p"},"alice")," at the beginning of the file,\nwith a different address from the ",(0,i.kt)("strong",{parentName:"p"},"administrator"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'administrator = "tz1L738ifd66ah69PrmKAZzckvvHnbcSeqjf"\nalice = "tz1LFuHW4Z9zsCwg1cgGTKU12WZAs27ZD14v"\n')),(0,i.kt)("p",null,"Then following the first test, let's write the new test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'def test_should_failed_if_the_source_is_not_the_administrator(self):\n    with self.assertRaises(MichelsonRuntimeError) as administrator_error:\n        # GIVEN\n        storage = {"administrator": administrator, "counter": 0}\n        value = 5\n\n        # WHEN\n        self.counterContract.increment(value).interpret(storage=storage, source=alice)\n\n    # THEN\n    error_message = str(administrator_error.exception.args[-1].strip("\\\\").strip("\'"))\n    self.assertEqual("administrator not recognized", error_message)\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The line ",(0,i.kt)("inlineCode",{parentName:"li"},"with self.assertRaises(MichelsonRuntimeError) as administrator_error:"),"\nretrieves and stores the error in the ",(0,i.kt)("inlineCode",{parentName:"li"},"administrator_error")," variable. "),(0,i.kt)("li",{parentName:"ul"},"The administrator's address is still defined in the initial state of storage\nbut this time alice's address is specified in the context's source variable: ",(0,i.kt)("inlineCode",{parentName:"li"},"source=alice"),"."),(0,i.kt)("li",{parentName:"ul"},"Finally, the string message from the error is stored in the variable ",(0,i.kt)("inlineCode",{parentName:"li"},"error_message"),"\nand is compared with the original message written in the ",(0,i.kt)("inlineCode",{parentName:"li"},"failwith()")," of the LIGO code. ")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"python -m unittest test_counter.TestCounterContract.test_should_failed_if_the_source_is_not_the_administrator\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"----------------------------------------------------------------------\nRan 1 test in 0.011s\n\nOK\n\n")),(0,i.kt)("p",null,"Now it's your turn to write your tests!\nTry to do the same thing with the entrypoint ",(0,i.kt)("inlineCode",{parentName:"p"},"decrement")," for example.",(0,i.kt)("br",{parentName:"p"}),"\n","The goal of writing tests is to have optimal coverage of the whole code.",(0,i.kt)("br",{parentName:"p"}),"\n","This allows you to have a robust and high-quality code.\nMoreover, future developers that use your code will thank you, very much."))}p.isMDXComponent=!0},4926:function(e,t,n){"use strict";t.Z=n.p+"assets/images/pyramide_of_tests-b40f9d80b14fb0d8f1bb1b9e0009069a.svg"}}]);