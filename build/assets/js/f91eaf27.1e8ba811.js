(self.webpackChunkopentezos=self.webpackChunkopentezos||[]).push([[6361],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return d},kt:function(){return h}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},d=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(a),h=o,f=u["".concat(s,".").concat(h)]||u[h]||p[h]||r;return a?n.createElement(f,i(i({ref:t},d),{},{components:a})):n.createElement(f,i({ref:t},d))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var c=2;c<r;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},963:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return i},metadata:function(){return l},toc:function(){return s},default:function(){return d}});var n=a(2122),o=a(9756),r=(a(7294),a(3905)),i={id:"lending",title:"Lending and Flash Loans",author:"Aymeric Bethencourt"},l={unversionedId:"defi/lending",id:"defi/lending",isDocsHomePage:!1,title:"Lending and Flash Loans",description:"In your life, you have probably had to borrow money, e.g., for a student loan, a car loan, or a mortgage. Lending and borrowing are essential services in any financial system. Traditionally, lenders such as banks, provide you with a loan in exchange for a fee in the form of an interest rate. Repaying the said loan is enforced by legal contracts with the bank.",source:"@site/docs/defi/lending.md",sourceDirName:"defi",slug:"/defi/lending",permalink:"/defi/lending",editUrl:"https://github.com/octo-technology/OpenTezos/tree/main/docs/defi/lending.md",version:"current",lastUpdatedBy:"Theotime-Akeare",lastUpdatedAt:1623083507,formattedLastUpdatedAt:"6/7/2021",frontMatter:{id:"lending",title:"Lending and Flash Loans",author:"Aymeric Bethencourt"},sidebar:"docs",previous:{title:"Synthetics",permalink:"/defi/synthetics"},next:{title:"Exam",permalink:"/defi/exam"}},s=[{value:"DeFi loans",id:"defi-loans",children:[{value:"Definition",id:"definition",children:[]},{value:"Example",id:"example",children:[]},{value:"Liquidation",id:"liquidation",children:[]},{value:"Interests",id:"interests",children:[]},{value:"Lending on Tezos",id:"lending-on-tezos",children:[]}]},{value:"Flash loans",id:"flash-loans",children:[{value:"Transactions",id:"transactions",children:[]}]},{value:"Use cases",id:"use-cases",children:[{value:"Arbitrage",id:"arbitrage",children:[]},{value:"Collateral Swaps",id:"collateral-swaps",children:[]},{value:"Self-liquidation.",id:"self-liquidation",children:[]},{value:"Conclusion",id:"conclusion",children:[]},{value:"Flash loans on Tezos",id:"flash-loans-on-tezos",children:[]}]},{value:"References",id:"references",children:[]}],c={toc:s};function d(e){var t=e.components,i=(0,o.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"In your life, you have probably had to borrow money, e.g., for a student loan, a car loan, or a mortgage. Lending and borrowing are essential services in any financial system. Traditionally, lenders such as banks, provide you with a loan in exchange for a fee in the form of an interest rate. Repaying the said loan is enforced by legal contracts with the bank."),(0,r.kt)("p",null,"Similar situations can be found on the blockchain as well. A borrower needs a sum of money immediately available for an operation, and a lender may agree to provide such a loan in exchange for a fee. "),(0,r.kt)("h2",{id:"defi-loans"},"DeFi loans"),(0,r.kt)("h3",{id:"definition"},"Definition"),(0,r.kt)("p",null,"DeFi lending allows users to become lenders or borrowers in a completely decentralized and permissionless way while maintaining full custody over their coins. "),(0,r.kt)("p",null,"Users, who want to become lenders, supply their tokens to a particular money market and start receiving interest on their tokens according to the current supply ",(0,r.kt)("strong",{parentName:"p"},"APY")," (Annual Percentage Yield). "),(0,r.kt)("p",null,"But how do you enforce the repayment of a loan on the blockchain? "),(0,r.kt)("p",null,"Each loan on the blockchain needs to be collateralized with other tokens. Even worse, as tokens are very volatile, blockchain loans are over-collateralized (often at 133%). For instance, if you want to borrow $1m in USDS, you need to provide $1.33m in XTZ as collateral. "),(0,r.kt)("p",null,"You may then wonder, why would anyone take a loan if they need to provide even more as collateral?"),(0,r.kt)("p",null,"There are multiple reasons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"They may not want to sell their original tokens."),(0,r.kt)("li",{parentName:"ul"},"They may want to avoid or delay paying capital gain taxes on their tokens."),(0,r.kt)("li",{parentName:"ul"},"They may want to use the borrowed funds to increase their leverage in a certain position. ")),(0,r.kt)("h3",{id:"example"},"Example"),(0,r.kt)("p",null,"For instance, Alice has 133 USDS and believes the price of XTZ will go down. To benefit from this, Alice takes a loan of 20 XTZ using here 133 USDS (considering 5 USDS per XTZ, plus 33% for over-collateralization). She immediately sells the 20 XTZ for 100 USDS. She now has 233 USDS (133 initially plus 100 from the sale) and owes a debt of 20 XTZ. Consider that XTZ goes down to ",(0,r.kt)("span",{parentName:"p",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex-error",title:"ParseError: KaTeX parse error: Can't use function '$' in math mode at position 127: \u2026Alice now have $\u0332233 - 40 = 193",style:{color:"#cc0000"}},"2. Alice buys 20 XTZ for 40 USDS, repays the 20 XTZ to the lender, and retrieves her 133 USDS collateral back. Alice now have $233 - 40 = 193"))," USDS. She has made a $60 benefit. This whole operation is called a ",(0,r.kt)("em",{parentName:"p"},"short position"),"."),(0,r.kt)("h3",{id:"liquidation"},"Liquidation"),(0,r.kt)("p",null,"As long as the value of the collateral is superior or equal to 133% of the borrowed funds, there are no limits to how long a user can keep the borrowed funds for."),(0,r.kt)("p",null,"However, if the value of the collateral falls below 133%, the user then has his collateral liquidated for the protocol to repay the borrowed amount."),(0,r.kt)("h3",{id:"interests"},"Interests"),(0,r.kt)("p",null,"Borrowers pay lenders interests on their loans, plus a platform fee. The interest rate is determined by supply and demand. For instance, if many lenders are offering loans for XTZ and demand is low, interest rates will be lowered to attract more demand. However, if there are few lenders but demand is high, interests are increased (lenders obviously want to earn as much money as possible). For instance, if traders believe the price of XTZ will go down, a lot of them might want to open ",(0,r.kt)("em",{parentName:"p"},"short positions")," as seen in the example above, and therefore increase the demand for loans."),(0,r.kt)("p",null,"Interests paid on loans are based on their APY. Lenders usually offer two kinds of APY:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A variable APY, which is updated at every block depending on offer and demand."),(0,r.kt)("li",{parentName:"ul"},"A much higher but stable APY that will not change during the whole period of your loan.")),(0,r.kt)("p",null,"Variable rates may sometimes be low and attractive, but keep in mind that they can sharply move at any time. As seen above, if XTZ crashes, demand for loans increases, and variable APYs can skyrocket."),(0,r.kt)("p",null,"For instance, if you borrow $100 for a year at a stable APY of 10%, you will pay $10 interest. Now consider borrowing at a 5% variable APY, but after 6 months, the APY jumps to 30% for the rest of the year. You would then have to pay $2.5 interest for the first 6 months and $15 for the last 6 months."),(0,r.kt)("p",null,"Note that interests are computed at each block, increasing your debt a little every time. If APY jumps sharply, your debt might surpass the 133% collateral limit. You must close your loan or add more collateral, or your loan will be liquidated. This is how you can get liquidated based only on accrued interests even if the tokens borrowed and used as collateral hasn't changed in price (typically borrowing stablecoins with stablecoins)."),(0,r.kt)("h3",{id:"lending-on-tezos"},"Lending on Tezos"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://tezos.finance/"},'Tezos Finance (aka "Tezfin")')," is currently in development and will soon enable lending and borrowing of fungible Tezos crypto-assets including XTZ and Tezos-based tokens built with the FA token standards."),(0,r.kt)("h2",{id:"flash-loans"},"Flash loans"),(0,r.kt)("p",null,"Flash loans have been popularized in 2020 and are very useful, they allow one to ",(0,r.kt)("strong",{parentName:"p"},"borrow tokens without any collateral"),". What's the catch?"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"A flash loan has to be borrowed and repaid within the same blockchain transaction.")," "),(0,r.kt)("p",null,"To understand this concept, let's recall how transactions work on Tezos."),(0,r.kt)("h3",{id:"transactions"},"Transactions"),(0,r.kt)("p",null,"A transaction represents a set of steps that must be executed in an atomic way, i.e., either all the steps are executed, or the transaction is rolled back, and none of the steps take place."),(0,r.kt)("p",null,"Sending XTZ, sending FA2 tokens, and interacting with smart contracts can be steps executed within the scope of one transaction. "),(0,r.kt)("p",null,"Transactions are grouped and included in a Tezos block. Each transaction can be observed on a block explorer such as ",(0,r.kt)("a",{parentName:"p",href:"https://tzstats.com/"},"tzstats"),"."),(0,r.kt)("p",null,"On Tezos, transactions can consist of multiple consecutive steps, e.g., you could supply XTZ and borrow kUSD on ",(0,r.kt)("em",{parentName:"p"},"TezFin"),", swap half of your borrowed kUSD for USDS on ",(0,r.kt)("em",{parentName:"p"},"Dexter")," and provide liquidity to the kUSD/USDS pool on ",(0,r.kt)("em",{parentName:"p"},"Quipuswap")," - all in one single Tezos transaction. If any of these steps result in an error, the whole transaction would be rolled back, and none of the steps would occur. Note that you would still have to pay the gas fees. Even failed contract executions consume gas.  "),(0,r.kt)("p",null,"The gas cost bounds the number of steps in a single transaction. So although you could, in theory, create a valid transaction with thousands of steps, it'd be rejected because of the maximum limit on gas cost per block. "),(0,r.kt)("p",null,"Remember that a flash loan has to be borrowed and repaid within the same transaction, so there is no risk that borrowers will not repay their borrowed amount."),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(2002).Z})),(0,r.kt)("small",{className:"figure"},"FIGURE 1: Operation flow of a flash loan in the case of a successful repayment (green arrows) or failed repayment (red arrows)"),(0,r.kt)("h2",{id:"use-cases"},"Use cases"),(0,r.kt)("p",null,"Here are three of the most common use cases for flash loans:"),(0,r.kt)("h3",{id:"arbitrage"},"Arbitrage"),(0,r.kt)("p",null,"Arbitrage is the simultaneous purchase and sale of the same asset in different exchanges to profit from tiny differences in the asset's listed price. It exploits short-lived variations in the price of identical or similar financial instruments in other markets."),(0,r.kt)("p",null,"Flash loans are particularly interesting for arbitrageurs to increase profits. FIGURE 2 presents an arbitrage opportunity. Let's suppose that the price of USDS is currently 1 kUSD on ",(0,r.kt)("em",{parentName:"p"},"Dexter")," but 0.99 kUSD on ",(0,r.kt)("em",{parentName:"p"},"Quipuswap"),". An arbitrageur would exploit the difference as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 1: Borrow 100,000 kUSD from TezFin"),(0,r.kt)("li",{parentName:"ul"},"Step 2: Exchange 100,000 kUSD against 101,010 USDS on ",(0,r.kt)("em",{parentName:"li"},"Quipuswap")),(0,r.kt)("li",{parentName:"ul"},"Step 3: Exchange 101,010 USDS against 101,010 kUSD on ",(0,r.kt)("em",{parentName:"li"},"Dexter")),(0,r.kt)("li",{parentName:"ul"},"Step 4: Repay the 100,000 kUSD on TezFin (plus usually a 0.09% fee making the total repayment at 100,900 kUSD)"),(0,r.kt)("li",{parentName:"ul"},"Step 5: Keep the remaining 110 kUSD in profits!")),(0,r.kt)("p",null,"All these steps are included in one transaction. They either all succeed, or they will all fail."),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(8555).Z})),(0,r.kt)("small",{className:"figure"},"FIGURE 2: A typical arbitrage operation involving a flash loan."),(0,r.kt)("p",null,"This process looks pretty easy, but keep in mind that arbitrageurs will still need to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"pay network fees, which can be pretty high in complex transactions."),(0,r.kt)("li",{parentName:"ul"},"take price slippage into account. (As seen in the ",(0,r.kt)("a",{parentName:"li",href:"/defi/dexs"},"DEX chapter"),", depending on the size of your order, ",(0,r.kt)("em",{parentName:"li"},"marginal price")," and ",(0,r.kt)("em",{parentName:"li"},"effective swap price")," can be quite different, leading to possible unprofitable outcomes)."),(0,r.kt)("li",{parentName:"ul"},"face fierce competition. Arbitrage is a well-known practice, and many traders are doing it. On top of that, bots that monitor the ",(0,r.kt)("em",{parentName:"li"},"mempool")," ",(0,r.kt)("a",{parentName:"li",href:"/defi/lending#references"},"[4]")," can pick up your profitable arbitrage opportunity and send the same transaction with a higher gas fee, which would be inserted in a block sooner, basically stealing your arbitrage opportunity.")),(0,r.kt)("h3",{id:"collateral-swaps"},"Collateral Swaps"),(0,r.kt)("p",null,"Another application of flash loans is for collateral swaps. Let's say you have borrowed kUSD from TezFin with XTZ as collateral. You can swap your collateral from XTZ to, for example, tzBTC in the following way:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 1: Take a flash loan in kUSD to cover the amount of kUSD that was borrowed"),(0,r.kt)("li",{parentName:"ul"},"Step 2: Repay your TezFin loan with borrowed kUSD "),(0,r.kt)("li",{parentName:"ul"},"Step 3: Withdraw your XTZ "),(0,r.kt)("li",{parentName:"ul"},"Step 4: Swap your XTZ for tzBTC on Uniswap "),(0,r.kt)("li",{parentName:"ul"},"Step 5: Supply tzBTC as collateral on TezFin "),(0,r.kt)("li",{parentName:"ul"},"Step 6: Borrow kUSD against your tzBTC collateral "),(0,r.kt)("li",{parentName:"ul"},"Step 7: Repay flash loan with the borrowed kUSD + fee "),(0,r.kt)("li",{parentName:"ul"},"Step 8: Congrats, you just swapped your collateral from XTZ to tzBTC and only paid 0.09% of the borrowed amount for this. ")),(0,r.kt)("h3",{id:"self-liquidation"},"Self-liquidation."),(0,r.kt)("p",null,"Finally, flash loans can also be used for self-liquidation. Let's say that you have a loan in kUSD on TezFin with XTZ as collateral. The XTZ price keeps going down, and you're approaching the liquidation level. You also don't have or don't want to deposit more XTZ to decrease your liquidation level and you also don't have the kUSD required to repay the loan. Now, instead of allowing the contract to liquidate your collateral and charge you the liquidation fee, you can take the following steps:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 1: Take a flash loan for the amount of kUSD that you owe"),(0,r.kt)("li",{parentName:"ul"},"Step 2: Repay your kUSD loan and withdraw your XTZ"),(0,r.kt)("li",{parentName:"ul"},"Step 3: Swap enough XTZ to kUSD to repay the flash loan + fees "),(0,r.kt)("li",{parentName:"ul"},"Step 4: Keep the rest of your XTZ ")),(0,r.kt)("h3",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"Flash loans are helpful building blocks in DeFi as they can be used for things like arbitrage, swapping collateral, and self-liquidation. Of course, the concept of flash loans is relatively new, and there are use cases still to be discovered in the future. "),(0,r.kt)("h3",{id:"flash-loans-on-tezos"},"Flash loans on Tezos"),(0,r.kt)("p",null,"Flash loans are not yet available on Tezos, but works are in progress."),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("p",null,"[1]"," ",(0,r.kt)("a",{parentName:"p",href:"https://tezos.finance/"},"https://tezos.finance/")),(0,r.kt)("p",null,"[2]"," ",(0,r.kt)("a",{parentName:"p",href:"https://medium.com/tezosfinance/tezos-finance-on-chain-lending-f59987fbb3de"},"https://medium.com/tezosfinance/tezos-finance-on-chain-lending-f59987fbb3de")),(0,r.kt)("p",null,"[3]"," ",(0,r.kt)("a",{parentName:"p",href:"https://finematics.com/lending-and-borrowing-in-defi-explained/"},"https://finematics.com/lending-and-borrowing-in-defi-explained/")),(0,r.kt)("p",null,"[4]"," A pool (set) of operations maintained by a node and not yet included in a block."))}d.isMDXComponent=!0},8555:function(e,t,a){"use strict";t.Z=a.p+"assets/images/arbitrage-bbe91c24ee289987ad0e6e968be973de.svg"},2002:function(e,t,a){"use strict";t.Z=a.p+"assets/images/flash-loan-3fe70a4dee6d74e8b0846f1f5d7e2ba1.svg"}}]);