(self.webpackChunkopentezos=self.webpackChunkopentezos||[]).push([[9671],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return c},kt:function(){return d}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var p=n.createContext({}),l=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=l(e.components);return n.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=l(a),d=o,u=h["".concat(p,".").concat(d)]||h[d]||m[d]||r;return a?n.createElement(u,i(i({ref:t},c),{},{components:a})):n.createElement(u,i({ref:t},c))}));function d(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=h;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<r;l++)i[l]=a[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},9015:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return i},metadata:function(){return s},toc:function(){return p},default:function(){return c}});var n=a(2122),o=a(9756),r=(a(7294),a(3905)),i={id:"operations",title:"Operations",authors:"Thomas Zoughebi, Aymeric Bethencourt, and Maxime Fernandez"},s={unversionedId:"tezos-basics/operations",id:"tezos-basics/operations",isDocsHomePage:!1,title:"Operations",description:"This chapter introduces the notion of Operations on Tezos. These are more commonly known as Transactions on other blockchains.",source:"@site/docs/tezos-basics/operations.md",sourceDirName:"tezos-basics",slug:"/tezos-basics/operations",permalink:"/tezos-basics/operations",editUrl:"https://github.com/octo-technology/OpenTezos/tree/main/docs/tezos-basics/operations.md",version:"current",lastUpdatedBy:"ThomasZoughebi",lastUpdatedAt:1622562840,formattedLastUpdatedAt:"6/1/2021",frontMatter:{id:"operations",title:"Operations",authors:"Thomas Zoughebi, Aymeric Bethencourt, and Maxime Fernandez"},sidebar:"docs",previous:{title:"Liquid Proof-of-Stake",permalink:"/tezos-basics/liquid-proof-of-stake"},next:{title:"CLI and RPC",permalink:"/tezos-basics/cli-and-rpc"}},p=[{value:"Implicit accounts and originated accounts",id:"implicit-accounts-and-originated-accounts",children:[]},{value:"Tezos operations",id:"tezos-operations",children:[]},{value:"Operation Flow",id:"operation-flow",children:[{value:"Pre-validator",id:"pre-validator",children:[]},{value:"Mempool",id:"mempool",children:[]},{value:"Baking and endorsement",id:"baking-and-endorsement",children:[]},{value:"Validator",id:"validator",children:[]}]},{value:"What have we learned so far?",id:"what-have-we-learned-so-far",children:[]},{value:"References",id:"references",children:[]}],l={toc:p};function c(e){var t=e.components,i=(0,o.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,n.Z)({},l,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This chapter introduces the notion of ",(0,r.kt)("em",{parentName:"p"},"Operations")," on Tezos. These are more commonly known as ",(0,r.kt)("em",{parentName:"p"},"Transactions")," on other blockchains."),(0,r.kt)("h2",{id:"implicit-accounts-and-originated-accounts"},"Implicit accounts and originated accounts"),(0,r.kt)("p",null,"Let's start by talking about the two types of addresses in Tezos ",(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[1]"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"An ",(0,r.kt)("strong",{parentName:"p"},"implicit account")," is linked to a ",(0,r.kt)("strong",{parentName:"p"},"manager")," (see ",(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/smart-contracts#general-definition-of-a-tezos-smart-contract"},(0,r.kt)("em",{parentName:"a"},"General definition of a tezos smart contract")),"), which owns the ",(0,r.kt)("em",{parentName:"p"},"public key"),". The hash of the ",(0,r.kt)("em",{parentName:"p"},"public key")," outputs an ",(0,r.kt)("strong",{parentName:"p"},"address"),". Depending on the chosen ",(0,r.kt)("strong",{parentName:"p"},"D"),"igital ",(0,r.kt)("strong",{parentName:"p"},"S"),"ignature ",(0,r.kt)("strong",{parentName:"p"},"A"),"lgorithm's ",(0,r.kt)("strong",{parentName:"p"},"e"),"lliptic ",(0,r.kt)("strong",{parentName:"p"},"c"),"urve (see ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm"},"ECDSA"),'), the latter starts with "',(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"tz1")),'" (Ed25519 curve), "',(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"tz2")),'" (',(0,r.kt)("a",{parentName:"p",href:"https://en.bitcoin.it/wiki/Secp256k1"},"Secp256k1"),' curve), or "',(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"tz3")),'" (P256 curve) ',(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[2]"),".",(0,r.kt)("br",{parentName:"p"}),"\n","A ",(0,r.kt)("em",{parentName:"p"},"transfer")," operation to the account's address creates the account itself.",(0,r.kt)("br",{parentName:"p"}),"\n","Only ",(0,r.kt)("em",{parentName:"p"},"implicit")," accounts can be registered as ",(0,r.kt)("em",{parentName:"p"},"delegates")," and participate in the ",(0,r.kt)("em",{parentName:"p"},"baking process"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Smart contracts"),' are also called "',(0,r.kt)("strong",{parentName:"p"},"originated accounts"),'" and are created with an ',(0,r.kt)("strong",{parentName:"p"},"origination")," operation (see the ",(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/smart-contracts#deployment-of-a-tezos-smart-contract"},(0,r.kt)("em",{parentName:"a"},"Smart Contracts"))," chapter). They don't have a private key and public key pair. Originated accounts' addresses start with ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"KT1")),".",(0,r.kt)("br",{parentName:"p"}),"\n","They run their Michelson code each time they receive an operation."))),(0,r.kt)("h2",{id:"tezos-operations"},"Tezos operations"),(0,r.kt)("p",null,"An operation is a ",(0,r.kt)("em",{parentName:"p"},"message")," sent from one address to another."),(0,r.kt)("p",null,"Message representation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"type operation = {\n  amount: amount; // amount being sent\n  parameters: data list; // parameters passed to the script\n  counter: int; // invoice id to avoid replay attacks\n  destination: contract hash;\n}\n")),(0,r.kt)("p",null,"Example of an entrypoint call:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "branch": "BMXRpSqjJ9HnEeaSXj3YzM9jqB4kqDZemtJBGGqn5Sa9MepV1k7",\n    "contents": [\n        {\n            "kind": "transaction",\n            "source": "tz1YWK1gDPQx9N1Jh4JnmVre7xN6xhGGM4uC",\n            "fee": "6678",\n            "counter": "942780",\n            "gas_limit": "63669",\n            "storage_limit": "75",\n            "amount": "0",\n            "destination": "KT1S5hgipNSTFehZo7v81gq6fcLChbRwptqy",\n            "parameters": {\n                "entrypoint": "sellLand",\n                "value": {\n                    "prim": "Pair",\n                    "args": [\n                        {"int": "100000000"},\n                        {"int": "11"}\n                    ]\n                }\n            }\n        }\n    ]\n}\n')),(0,r.kt)("p",null,"Example of a transaction between two ",(0,r.kt)("strong",{parentName:"p"},"implicit")," accounts:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "branch": "BKkwBsr6hfvj2MfaEydByALrASfCPzFBFSCs3iY7XaBLKRtwWj7",\n    "contents": [\n        {\n            "kind": "transaction",\n            "source": "tz1VAugX5LBcF4Anq1gEFr12LmsjqsCgsnPs",\n            "fee": "444",\n            "counter": "855452",\n            "gas_limit": "1527",\n            "storage_limit": "0",\n            "amount": "100000000",\n            "destination": "tz1YWK1gDPQx9N1Jh4JnmVre7xN6xhGGM4uC"\n        }\n    ]\n}\n')),(0,r.kt)("p",null,"Such an operation can be sent from an implicit account (if signed using the manager's private key) or programmatically by contract code execution. When the operation is received, the amount is added to the destination contract's balance, and the destination contract's code is executed. This code can make use of the parameters passed on to it. It can read and write the contract's storage and post operations to other contracts."),(0,r.kt)("p",null,"As the example shows, there is also a ",(0,r.kt)("em",{parentName:"p"},"counter")," field, whose purpose is to prevent ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Replay_attack"},"replay attacks"),". An operation is only valid if the contract's ",(0,r.kt)("em",{parentName:"p"},"counter")," is equal to the operation's ",(0,r.kt)("em",{parentName:"p"},"counter"),". Once an operation is applied, the ",(0,r.kt)("em",{parentName:"p"},"counter")," increases by one, preventing the operation from being reused."),(0,r.kt)("p",null,'The operation also includes the block hash ("',(0,r.kt)("em",{parentName:"p"},"branch"),'" field) of a recent block that the client considers valid. If an attacker ever succeeds in forcing a long reorganization with a fork, he will be unable to include this operation making the fork obviously fake.'),(0,r.kt)("p",null,'This last line of defense is named "',(0,r.kt)("em",{parentName:"p"},"TAPOS"),'": a statistical detection of a ',(0,r.kt)("em",{parentName:"p"},"Long Range Attack")," (see ",(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/liquid-proof-of-stake#long-range-attack"},(0,r.kt)("em",{parentName:"a"},"Liquid Proof of Stake"))," chapter) based on the fraction of moving coins. This kind of system prevents long reorganizations but is inefficient with short-term double-spending."),(0,r.kt)("p",null,"Currently the Tezos network can process 40 TPS (operations (transactions) per second) and has an operation confirmation time of 30 minutes ",(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[3]"),". This speed may vary with future protocols. Operation confirmation time is the time it takes for an operation to be considered secure. As a comparison, ",(0,r.kt)("em",{parentName:"p"},"Bitcoin")," can process 7 TPS and has a confirmation time of 60 minutes (6 valid blocks)."),(0,r.kt)("p",null,"Note that a Tezos operation's maximum size is ",(0,r.kt)("strong",{parentName:"p"},"512kB"),"."),(0,r.kt)("h2",{id:"operation-flow"},"Operation Flow"),(0,r.kt)("p",null,"The diagram below represents the life cycle of an operation:"),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(1539).Z})),(0,r.kt)("small",{className:"figure"},"FIGURE 1: Life cycle of an operation"),(0,r.kt)("p",null,"Nodes receive operations from clients via RPC or from a network peer."),(0,r.kt)("h3",{id:"pre-validator"},"Pre-validator"),(0,r.kt)("p",null,"The ",(0,r.kt)("em",{parentName:"p"},"Pre-validator"),(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[4]")," is an operation's validation subsystem. It decides which operation to add to the ",(0,r.kt)("em",{parentName:"p"},"mempool")," (memory pool)."),(0,r.kt)("p",null,"The pre-validation consists of 3 steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Pre_filter")," step",(0,r.kt)("br",{parentName:"p"}),"\n","Checks that there is enough provided ",(0,r.kt)("em",{parentName:"p"},"gas")," (and if the sender's account has enough funds to pay)")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Apply")," step",(0,r.kt)("br",{parentName:"p"}),"\n","Checks whether the operation is in adequacy with the current state of the Tezos chain")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Post_filter")," step",(0,r.kt)("br",{parentName:"p"}),"\n","Decides whether to add the operation to the ",(0,r.kt)("em",{parentName:"p"},"mempool"),". If yes, broadcasts the result"))),(0,r.kt)("p",null,"If ",(0,r.kt)("em",{parentName:"p"},"any")," of these steps triggers an error, the pre-validator doesn't add the operation to the mempool."),(0,r.kt)("h3",{id:"mempool"},"Mempool"),(0,r.kt)("p",null,'The node maintains a memory pool to keep track of "',(0,r.kt)("em",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"em"},"not-invalid-for-sure")),'" operations.'),(0,r.kt)("p",null,"There are two different kinds:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Known_valid"),": A list of valid operations ready to go in a block")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Pending"),": A bounded set of operations eligible to broadcast. This set contains two sub-kinds of operations:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"branch_refused"),": an operation that could be valid in a different branch.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"branch_delayed"),": an operation that has come too soon (i.e. there's a gap in the account's counter)"))))),(0,r.kt)("p",null,"Operations in the mempool are broadcasted to peers whenever the mempool is updated. A node fetches an operation from another remote peer's advertisement using the operation's hash."),(0,r.kt)("p",null,"A valid operation lives in the mempool until its addition to a valid block on a chain the node considers canonical. If an operation isn't added to a block during its \"",(0,r.kt)("em",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"em"},"time-to-live")),"\" duration, it quits the mempool. As long as a transaction is in the mempool, the sender's address cannot issue another. However, it is possible to send multiple transactions at the same time in a batch."),(0,r.kt)("h3",{id:"baking-and-endorsement"},"Baking and endorsement"),(0,r.kt)("p",null,"Bakers are free to select operations from the mempool, but they usually use a minimum fee filter. After a block creation, endorsers check its validity. At the end of the allotted time, the selected baker collects endorsers' opinions, adds them to the block, and forges it."),(0,r.kt)("h3",{id:"validator"},"Validator"),(0,r.kt)("p",null,"The selected baker sends the created block to a node. Once received, the node starts the block validation by calling the ",(0,r.kt)("em",{parentName:"p"},"Apply_block")," function. This function validates the block header by using protocol parameters and verifies all the operations."),(0,r.kt)("p",null,"The block validation checks for errors such as too many operations, oversized operations, incorrect protocol versions, unauthorized validation passes, invalid fitness, unavailable protocols, errors while applying a transaction, and more ",(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[5]"),"."),(0,r.kt)("p",null,'Once a block is validated and is a candidate for the new head of the chain, it arrives the "',(0,r.kt)("em",{parentName:"p"},"chain validator"),'" which checks if the fitness score',(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[6]")," of the new head is higher than the fitness score of the current one. If it is not, the block is ignored. If it is, then this block replaces the current head. The ",(0,r.kt)("em",{parentName:"p"},"chain validator")," then calls the ",(0,r.kt)("em",{parentName:"p"},"pre-validator")," to flush the ",(0,r.kt)("em",{parentName:"p"},"mempool"),". Finally, the new head is advertised to the peers using the ",(0,r.kt)("em",{parentName:"p"},"distributed_db's Advertise module"),(0,r.kt)("a",{parentName:"p",href:"/tezos-basics/operations#references"},"[7]"),". Of course, this block only becomes part of the canonical chain if future bakers decide to bake on top of it."),(0,r.kt)("h2",{id:"what-have-we-learned-so-far"},"What have we learned so far?"),(0,r.kt)("p",null,"In this chapter, we discovered the Tezos operations and how they are validated."),(0,r.kt)("p",null,'In the next "',(0,r.kt)("em",{parentName:"p"},"CLI and RPC"),'" chapter, we will learn how to issue them with a node.'),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("p",null,"[1]"," ",(0,r.kt)("a",{parentName:"p",href:"https://tezos.gitlab.io/introduction/howtouse.html#implicit-accounts-and-smart-contracts"},"https://tezos.gitlab.io/introduction/howtouse.html#implicit-accounts-and-smart-contracts")),(0,r.kt)("p",null,"[2]"," ",(0,r.kt)("a",{parentName:"p",href:"https://www.ocamlpro.com/2018/11/21/an-introduction-to-tezos-rpcs-signing-operations/"},"https://www.ocamlpro.com/2018/11/21/an-introduction-to-tezos-rpcs-signing-operations/")),(0,r.kt)("p",null,"[3]"," ",(0,r.kt)("a",{parentName:"p",href:"https://alephzero.org/blog/what-is-the-fastest-blockchain-and-why-analysis-of-43-blockchains/"},"https://alephzero.org/blog/what-is-the-fastest-blockchain-and-why-analysis-of-43-blockchains/")),(0,r.kt)("p",null,"[4]"," ",(0,r.kt)("a",{parentName:"p",href:"https://medium.com/tqtezos/lifecycle-of-an-operation-in-tezos-248c51038ec2"},"https://medium.com/tqtezos/lifecycle-of-an-operation-in-tezos-248c51038ec2")),(0,r.kt)("p",null,"[5]"," ",(0,r.kt)("a",{parentName:"p",href:"https://gitlab.com/tezos/tezos/blob/mainnet/src/lib_shell_services/block_validator_errors.ml"},"https://gitlab.com/tezos/tezos/blob/mainnet/src/lib_shell_services/block_validator_errors.ml")),(0,r.kt)("p",null,"[6]"," ",(0,r.kt)("a",{parentName:"p",href:"https://tezos.gitlab.io/alpha/glossary.html?highlight=fitness#tezos"},"https://tezos.gitlab.io/alpha/glossary.html?highlight=fitness#tezos")),(0,r.kt)("p",null,"[7]"," ",(0,r.kt)("a",{parentName:"p",href:"https://tezos.gitlab.io/shell/validation.html#distributed-db"},"https://tezos.gitlab.io/shell/validation.html#distributed-db")))}c.isMDXComponent=!0},1539:function(e,t,a){"use strict";t.Z=a.p+"assets/images/operation_flow-7e54b4bc312856ddd81318ee6789daf9.svg"}}]);