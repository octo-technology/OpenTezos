(self.webpackChunkopentezos=self.webpackChunkopentezos||[]).push([[6123],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return d}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),d=i,h=u["".concat(l,".").concat(d)]||u[d]||m[d]||r;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},3539:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return s},toc:function(){return l},default:function(){return p}});var a=n(2122),i=n(9756),r=(n(7294),n(3905)),o={id:"smart-contracts",title:"Smart Contracts",authors:"Frank Hillard"},s={unversionedId:"michelson/smart-contracts",id:"michelson/smart-contracts",isDocsHomePage:!1,title:"Smart Contracts",description:"Smart contracts in Michelson",source:"@site/docs/michelson/smart-contracts.md",sourceDirName:"michelson",slug:"/michelson/smart-contracts",permalink:"/michelson/smart-contracts",editUrl:"https://github.com/octo-technology/OpenTezos/tree/main/docs/michelson/smart-contracts.md",version:"current",lastUpdatedBy:"AymericBethencourt",lastUpdatedAt:1622492036,formattedLastUpdatedAt:"5/31/2021",frontMatter:{id:"smart-contracts",title:"Smart Contracts",authors:"Frank Hillard"},sidebar:"docs",previous:{title:"Introduction",permalink:"/michelson"},next:{title:"Tutorial",permalink:"/michelson/tutorial"}},l=[{value:"Smart contracts in Michelson",id:"smart-contracts-in-michelson",children:[{value:"Parameter (Entrypoints)",id:"parameter-entrypoints",children:[]},{value:"Storage",id:"storage",children:[]},{value:"Code",id:"code",children:[]}]},{value:"Michelson overview",id:"michelson-overview",children:[{value:"Stack-based language",id:"stack-based-language",children:[]},{value:"Static typing",id:"static-typing",children:[]},{value:"Atomic computation",id:"atomic-computation",children:[]},{value:"Gas model",id:"gas-model",children:[]}]},{value:"Deployment - Address and balance",id:"deployment---address-and-balance",children:[]},{value:"Invocation and transaction return (list of operations, storage)",id:"invocation-and-transaction-return-list-of-operations-storage",children:[]},{value:"Explicit failure",id:"explicit-failure",children:[]}],c={toc:l};function p(e){var t=e.components,o=(0,i.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,a.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"smart-contracts-in-michelson"},"Smart contracts in Michelson"),(0,r.kt)("p",null,"Michelson is a domain-specific language and is designed to implement smart contracts. On Tezos, smart contracts are made of three parts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the ",(0,r.kt)("strong",{parentName:"li"},"parameter")," of the smart contract which describes the possible invocations of the smart contract (also called ",(0,r.kt)("strong",{parentName:"li"},"entrypoints"),") and their related arguments."),(0,r.kt)("li",{parentName:"ul"},"the ",(0,r.kt)("strong",{parentName:"li"},"storage"),", i.e., the type definition of the persistent data structure associated with the smart contract."),(0,r.kt)("li",{parentName:"ul"},"the ",(0,r.kt)("strong",{parentName:"li"},"code")," of the smart contract, i.e., a sequence of instructions to be executed when invoking the smart contract.")),(0,r.kt)("p",null,"A smart contract is defined by these three parts (parameter, storage, code). An empty smart contract looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"parameter unit;\nstorage unit;\ncode { CDR ;\n       NIL operation ;\n       PAIR };\n")),(0,r.kt)("p",null,"Let us now dig deeper into each part."),(0,r.kt)("h3",{id:"parameter-entrypoints"},"Parameter (Entrypoints)"),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"parameter")," of the smart contract describes all possible invocations of the smart contract. An ",(0,r.kt)("strong",{parentName:"p"},"entrypoint")," is an invocable function of the smart contract and usually takes arguments. Each entrypoint has specific arguments and is composed of:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the type definition of the expected argument of the entrypoint "),(0,r.kt)("li",{parentName:"ul"},"the annotation (name) of the entrypoint")),(0,r.kt)("p",null,"The example below shows a simple smart contract implementing a counter (it is not meant to be understood yet but illustrates the three parts of the smart contract)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{ parameter (or (or (nat %add) (nat %sub)) (unit %default)) ;\n  storage int ;\n  code { AMOUNT ; PUSH mutez 0 ; ASSERT_CMPEQ ; UNPAIR ;\n         IF_LEFT\n           { IF_LEFT { ADD } { SWAP ; SUB } }\n           { DROP ; DROP ; PUSH int 0 } ;\n         NIL operation ; PAIR } }\n")),(0,r.kt)("p",null,"Notice that the parameter describing possible invocations is defined as:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"(or (or (nat %add) (nat %sub)) (unit %default))\n")),(0,r.kt)("p",null,"It has three possible invocations (add, sub, and default) specified in a single logical structure composed of ",(0,r.kt)("em",{parentName:"p"},"or")," operators. Since ",(0,r.kt)("em",{parentName:"p"},"or")," needs two operands, you have to nest them to include three or more invocations."),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(5292).Z})),(0,r.kt)("small",{className:"figure"},"FIGURE 1: Representation of a nested _or_ structure  to specify three entrypoints"),(0,r.kt)("h3",{id:"storage"},"Storage"),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"storage")," is a persistent memory space associated with the smart contract when it is deployed. The data structure of the storage is defined in the smart contract during the deployment phase."),(0,r.kt)("p",null,"Notice that, in our ",(0,r.kt)("em",{parentName:"p"},"Counter")," contract above, the type definition that describes the storage is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"  storage int ;\n")),(0,r.kt)("p",null,"In our case, it is only storing one integer number."),(0,r.kt)("h3",{id:"code"},"Code"),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"code")," of the smart contract is a sequence of Michelson instructions separated by semi-colons ",(0,r.kt)("inlineCode",{parentName:"p"},";"),"."),(0,r.kt)("p",null,"We will look into this in more details in ",(0,r.kt)("a",{parentName:"p",href:"/michelson/instructions-reference"},"instructions")," and ",(0,r.kt)("a",{parentName:"p",href:"/michelson/tutorial"},"tutorial")," chapters, but before that, let's have a quick overview of the Michelson language."),(0,r.kt)("h2",{id:"michelson-overview"},"Michelson overview"),(0,r.kt)("p",null,"The Michelson language is the reference language for Tezos smart contracts. It is a low-level ",(0,r.kt)("strong",{parentName:"p"},"stack-based")," language (definition below). It is also ",(0,r.kt)("strong",{parentName:"p"},"Turing-complete"),", meaning it has all the basic operations to read/write/compare values in-memory, has infinite memory (up to the maximun gas use), and has conditional operators (e.g., ",(0,r.kt)("em",{parentName:"p"},"if")," and ",(0,r.kt)("em",{parentName:"p"},"switch"),")."),(0,r.kt)("p",null,"The Michelson language introduces data types for structuring data and instructions on these data types for manipulating data."),(0,r.kt)("h3",{id:"stack-based-language"},"Stack-based language"),(0,r.kt)("p",null,"Generally speaking, a ",(0,r.kt)("em",{parentName:"p"},"stack")," data structure is a linear collection of elements that can be added or removed with ",(0,r.kt)("inlineCode",{parentName:"p"},"PUSH")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"POP")," instructions. In the Michelson language, elements can be pushed to the top of the stack or removed from the top of the stack. This kind of stack is called LIFO (Last In First Out)."),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(4563).Z})),(0,r.kt)("small",{className:"figure"},"FIGURE 2: Illustration of a stack"),(0,r.kt)("p",null,"In the ",(0,r.kt)("a",{parentName:"p",href:"/michelson/tutorial"},"next chapter"),", we will look into basic stack manipulations powered by the Michelson language."),(0,r.kt)("h3",{id:"static-typing"},"Static typing"),(0,r.kt)("p",null,"The Michelson language is strongly typed. All data inserted into the stack must be typed, and operators manipulating these data must respect the typing rules."),(0,r.kt)("p",null,"The Michelson language introduces primitive types for modeling data and composite types allowing for complex data structure definitions. It also introduces particular types for smart contract modeling."),(0,r.kt)("p",null,"The Michelson language provides basic type support on numbers, sequence of characters, logical expressions, and timestamps:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nat")," represents a natural integer (e.g. 0, 3, 15)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"int")," represents a integer (e.g. -10, 2, 3)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"string"),' represents a sequence of characters (e.g. "Hello")'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"bool")," represents a boolean value (e.g. True, False)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"bytes")," represents a sequence of bytes (octet)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"unit")," represents a non-specified type."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"timestamp"),' represents a duration (e.g. NOW, 1571659294, "2019-09-26T10:59:51Z"; i.e. a string following the RFC3339 standard)')),(0,r.kt)("p",null,"Michelson also provides composite types for grouping properties:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"set")," represents an unordered collection of elements. It preserves the uniqueness of elements inside the collection (e.g. { 2; 4; 5; 7})"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"list")," represents an ordered collection of elements of the same type (e.g. { 2; 4; 5; 3; 5 })"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"map"),' represents an associative array formed of key-value elements (e.g. { Elt "Hello" 1 }) '),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"big_map")," is another representation of an associative array but can handle larger amounts of data"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"pair"),' represents a tuple of two elements (e.g., pair "World" 1).'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"option")," is a predefined variant type used to express whether there is a value of some type or ",(0,r.kt)("em",{parentName:"li"},"none"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"or")," is a variant type that can handle elements of different types.")),(0,r.kt)("p",null,"Finally, Michelson provides specific types for smart contract modeling:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"address")," represents an identifier for a user account or a deployed smart contract (e.g., ",(0,r.kt)("em",{parentName:"li"},"tz1faswCTDciRzE4oJ9jn2Vm2dvjeyA9fUzU"),")"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"mutez")," represents the smallest quantity of the Tezos crypto-currency (1 tez = 1,000,000 mutez)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"key")," is a byte sequence representing a public key (e.g., ",(0,r.kt)("em",{parentName:"li"},"edpkuBknW28nW72KG6RoH...")," )"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"key_hash")," represents a hashed key using a standard hashing function such as SHA512 (e.g., a string in base58 encoded form ",(0,r.kt)("em",{parentName:"li"},"tz1KqTpEZ7Yob7QbPE4Hy..."),")"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"signature")," is a byte sequence representing a message signed by a public key (e.g., ",(0,r.kt)("em",{parentName:"li"},"spsig1PPUFZucuAQybs5w..."),")"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"chain_id")," represents the network identifer (e.g., ",(0,r.kt)("em",{parentName:"li"},"0x7a06a770"),", ",(0,r.kt)("em",{parentName:"li"},"NetXynUjJNZm7wi"),")"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"operation")," represents a transaction"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"contract")," represents a contract interface used for contract interaction")),(0,r.kt)("p",null,"We'll see examples of usage in the next chapters."),(0,r.kt)("h3",{id:"atomic-computation"},"Atomic computation"),(0,r.kt)("p",null,"The Michelson language provides basic operations on these types:  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"numbers: addition, subtraction, multiplication, euclidean division, comparison"),(0,r.kt)("li",{parentName:"ul"},"string: split, concatenation, comparison"),(0,r.kt)("li",{parentName:"ul"},"crypto: standard hash function"),(0,r.kt)("li",{parentName:"ul"},"collection: standard collection manipulation (create, insert, remove, access, modification) "),(0,r.kt)("li",{parentName:"ul"},"currency: standard operations on XTZ crypto-currency"),(0,r.kt)("li",{parentName:"ul"},"smart contract: contract interactions, transfer, invocation of smart contracts, delegation")),(0,r.kt)("p",null,"These instructions introduce basic programming concepts such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"conditional branching: The ",(0,r.kt)("inlineCode",{parentName:"li"},"IF")," instruction family"),(0,r.kt)("li",{parentName:"ul"},"repetitive processing: ",(0,r.kt)("inlineCode",{parentName:"li"},"LOOP"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"ITER"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"MAP")," instructions"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Lambda")," functions: ",(0,r.kt)("inlineCode",{parentName:"li"},"LAMBDA")," instruction"),(0,r.kt)("li",{parentName:"ul"},"structuring data: ",(0,r.kt)("inlineCode",{parentName:"li"},"PAIR"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"UNPAIR"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"CAR"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"CDR"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"LEFT"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"RIGHT")," instructions, and ",(0,r.kt)("inlineCode",{parentName:"li"},"list"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"map"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"set")," composite types"),(0,r.kt)("li",{parentName:"ul"},"contract communication: ",(0,r.kt)("inlineCode",{parentName:"li"},"CONTRACT"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"TRANSFER_TOKENS")," instructions")),(0,r.kt)("h3",{id:"gas-model"},"Gas model"),(0,r.kt)("p",null,"A cost of execution (called ",(0,r.kt)("strong",{parentName:"p"},"gas"),") is associated with each Michelson instruction. This is the money that must be paid in order to execute the instructions. A maximun gas limit prevents the execution of infinite loop. "),(0,r.kt)("p",null,"Adding more memory space to the smart contract storage also has a cost (for each allocated byte)."),(0,r.kt)("p",null,"When invoking a smart contract, one must specify the maximun amount of gas that can be spent to execute the code."),(0,r.kt)("h2",{id:"deployment---address-and-balance"},"Deployment - Address and balance"),(0,r.kt)("p",null,"To be accessible to anyone on the Tezos network, a smart contract must be deployed. This deployment phase is called ",(0,r.kt)("strong",{parentName:"p"},"origination"),"."),(0,r.kt)("p",null,"Tezos smart contracts have built-in internal information available once the smart contract has been deployed:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"its ",(0,r.kt)("strong",{parentName:"li"},"address")," of the smart contract, that is a unique identifier."),(0,r.kt)("li",{parentName:"ul"},"its ",(0,r.kt)("strong",{parentName:"li"},"balance"),", representing the quantity of XTZ owned by the smart contract.")),(0,r.kt)("h2",{id:"invocation-and-transaction-return-list-of-operations-storage"},"Invocation and transaction return (list of operations, storage)"),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"invocation")," of a smart contract is an explicit call for executing the smart contract code. It requires a call parameter which is a tuple of two elements (",(0,r.kt)("inlineCode",{parentName:"p"},"PAIR"),") containing:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the value of the entrypoint"),(0,r.kt)("li",{parentName:"ul"},"the value of the storage (current storage state)")),(0,r.kt)("p",null,"The invocation of the smart contract is expected to produce a tuple of two elements (",(0,r.kt)("inlineCode",{parentName:"p"},"PAIR"),") containing:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"a list of operations (which are the new transactions generated by this invocation, if any)."),(0,r.kt)("li",{parentName:"ul"},"the new storage state.")),(0,r.kt)("p",null,"The list of operations represents all of the impacts your contract will have on the rest of the Tezos blockchain. The new storage state represents the impact your invocation will have on the contract storage."),(0,r.kt)("p",null,'The diagram below describes the execution of an "empty smart contract" (as seen in the previous section). Although this contract does not modify anything, it still has respect the input and output formats. '),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(6305).Z})),(0,r.kt)("small",{className:"figure"},"FIGURE 3: Execution of `CDR ; NIL operation ; PAIR`"),(0,r.kt)("p",null,"Notice that this script performs no modification on the blockchain. The storage is given as a parameter and returned modified."),(0,r.kt)("h2",{id:"explicit-failure"},"Explicit failure"),(0,r.kt)("p",null,"When invoking a smart contract, the execution of the sequence of instructions may successfully finish. In this case, the transaction is considered finalized. If the execution of the sequence of instructions stops before the end, the transaction is considered to be rejected. The following chapters will introduce the Michelson instruction ",(0,r.kt)("inlineCode",{parentName:"p"},"FAIL")," which is responsible for throwing an error in case of failed execution."))}p.isMDXComponent=!0},5292:function(e,t,n){"use strict";t.Z=n.p+"assets/images/michelson_entrypoint_or_example-e75998e31498c1d331fabc94ccda44e8.svg"},6305:function(e,t,n){"use strict";t.Z=n.p+"assets/images/michelson_smartcontract_basics-1e6ca476f5a13cceedbda97b25b68ce8.svg"},4563:function(e,t,n){"use strict";t.Z=n.p+"assets/images/michelson_stack_basics-43b0dbca7d570e3127707d2ed347c0a2.svg"}}]);