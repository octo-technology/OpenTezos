(self.webpackChunkopentezos=self.webpackChunkopentezos||[]).push([[218],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),d=r,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||o;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},4623:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return i},metadata:function(){return l},toc:function(){return s},default:function(){return p}});var a=n(2122),r=n(9756),o=(n(7294),n(3905)),i={id:"truffle_compilation_migration",title:"Smart contract deployment with Truffle",authors:"Benjamin Pilia"},l={unversionedId:"dapp/truffle_compilation_migration",id:"dapp/truffle_compilation_migration",isDocsHomePage:!1,title:"Smart contract deployment with Truffle",description:"Introduction",source:"@site/docs/dapp/truffle_compilation_migration.md",sourceDirName:"dapp",slug:"/dapp/truffle_compilation_migration",permalink:"/dapp/truffle_compilation_migration",editUrl:"https://github.com/octo-technology/OpenTezos/tree/main/docs/dapp/truffle_compilation_migration.md",version:"current",lastUpdatedBy:"AymericBethencourt",lastUpdatedAt:1620327772,formattedLastUpdatedAt:"5/6/2021",frontMatter:{id:"truffle_compilation_migration",title:"Smart contract deployment with Truffle",authors:"Benjamin Pilia"},sidebar:"docs",previous:{title:"Introduction",permalink:"/dapp"},next:{title:"Introduction",permalink:"/baking"}},s=[{value:"Introduction",id:"introduction",children:[]},{value:"About The <em>Truffle</em> Suite",id:"about-the-truffle-suite",children:[]},{value:"<em>Truffle</em> Installation",id:"truffle-installation",children:[]},{value:"Setting-up a <em>Truffle</em> project",id:"setting-up-a-truffle-project",children:[{value:"1. Initializing an empty project",id:"1-initializing-an-empty-project",children:[]},{value:"2. Using a <em>Truffle</em> Box",id:"2-using-a-truffle-box",children:[]}]},{value:"Using <em>Truffle</em>",id:"using-truffle",children:[{value:"Project Structure overview",id:"project-structure-overview",children:[]},{value:"Main <em>Truffle</em> commands",id:"main-truffle-commands",children:[]},{value:"Compiling smart contracts with <em>Truffle</em>",id:"compiling-smart-contracts-with-truffle",children:[]},{value:"Deploying smart contracts with <em>Truffle</em>",id:"deploying-smart-contracts-with-truffle",children:[]},{value:"Interacting with a deployed contract",id:"interacting-with-a-deployed-contract",children:[]}]},{value:"Conclusion",id:"conclusion",children:[]}],c={toc:s};function p(e){var t=e.components,n=(0,r.Z)(e,["components"]);return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"Your smart contract will eventually be deployed onto a Tezos network, whether for testing or real-life use.\nThere are several ways to do this, such as using the Tezos cli.\nHowever, during development, the smart contracts and the associated storage are very likely to change: new field, field removal, structure change.\nFor each change, a new deployment must be done.\nThus, the way the contract is deployed will have to change accordingly, especially for the initial storage.\nA minimal change in the storage definition can make the next deployment extremely tiresome with the Tezos cli."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," solves this difficulty. This tool uses scripts to perform smart contract deployments: thanks to a cli and a few configuration files, they are easier\nand faster. Besides, the way a smart contract is deployed can be versioned. There is a huge productivity improvement."),(0,o.kt)("h2",{id:"about-the-truffle-suite"},"About The ",(0,o.kt)("em",{parentName:"h2"},"Truffle")," Suite"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," is part of a suite of tools which make it easier to deploy written smart contracts onto a blockchain,\ncalled ",(0,o.kt)("em",{parentName:"p"},"The Truffle Suite"),"."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Truffle")," : used for the compilation and deployment of smart contracts onto a network"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Ganache"),": used to easily set-up and deploy a blockchain network"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"drizzle"),": used to easily write front-end applications, which interact with a deployed smart-contract."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Truffle teams"),": integration and smart contracts monitoring tools")),(0,o.kt)("p",null,"The ",(0,o.kt)("em",{parentName:"p"},"Truffle")," Suite is not available for all blockchains. It supports:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Ethereum"),(0,o.kt)("li",{parentName:"ul"},"Tezos"),(0,o.kt)("li",{parentName:"ul"},"Corda"),(0,o.kt)("li",{parentName:"ul"},"Quorum"),(0,o.kt)("li",{parentName:"ul"},"Hyperledger Fabric")),(0,o.kt)("p",null,"Only ",(0,o.kt)("em",{parentName:"p"},"Truffle")," and ",(0,o.kt)("em",{parentName:"p"},"Ganache")," (still in beta) are available for Tezos."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," takes Ligo files, compiles them and deploy them on any Tezos network with a single command. It\ndoes not support Smartpy scripts nor Morlaix scripts."),(0,o.kt)("h2",{id:"truffle-installation"},(0,o.kt)("em",{parentName:"h2"},"Truffle")," Installation"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," can be installed with docker or npm. The easiest way is to use ",(0,o.kt)("em",{parentName:"p"},"Truffle")," from the npm package."),(0,o.kt)("p",null,"You'll need to have NodeJS v8.9.4 or later on your machine."),(0,o.kt)("p",null,"Open a terminal and run:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"$ npm install -g truffle@tezos")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," will be installed globally (-g option)."),(0,o.kt)("h2",{id:"setting-up-a-truffle-project"},"Setting-up a ",(0,o.kt)("em",{parentName:"h2"},"Truffle")," project"),(0,o.kt)("p",null,"As described below, ",(0,o.kt)("em",{parentName:"p"},"Truffle")," is working with configuration files and scripts, which must be located in specific\nrepositories. You can set up your ",(0,o.kt)("em",{parentName:"p"},"Truffle")," project from scratch, but it is easier to use one of the two ways provided\nby ",(0,o.kt)("em",{parentName:"p"},"Truffle"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Initializing an empty project"),(0,o.kt)("li",{parentName:"ol"},"Using a ",(0,o.kt)("em",{parentName:"li"},"Truffle")," Box")),(0,o.kt)("h3",{id:"1-initializing-an-empty-project"},"1. Initializing an empty project"),(0,o.kt)("p",null,"Create a folder for your ",(0,o.kt)("em",{parentName:"p"},"Truffle")," project, and run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"$ mkdir tezos-example\n$ cd tezos-example\n$ truffle init\n")),(0,o.kt)("p",null,"It will create the standard folders and configuration files required by ",(0,o.kt)("em",{parentName:"p"},"Truffle"),"."),(0,o.kt)("h3",{id:"2-using-a-truffle-box"},"2. Using a ",(0,o.kt)("em",{parentName:"h3"},"Truffle")," Box"),(0,o.kt)("p",null,"A ",(0,o.kt)("em",{parentName:"p"},"Truffle")," box is an already set-up project, easily and quickly adjustable to the specific needs of a project. These\nboilerplates come with predefined settings (accounts, networks...), and a project structure, that has to be respected.\nThey can be launched instantly, and modified with little work. ",(0,o.kt)("em",{parentName:"p"},"Truffle")," provides users with a global boxes repository:\n",(0,o.kt)("a",{parentName:"p",href:"https://www.trufflesuite.com/boxes"},"https://www.trufflesuite.com/boxes")),(0,o.kt)("p",null,"A Tezos box can be found here:\n","[https://www.trufflesuite.com/boxes/tezos-example]"),(0,o.kt)("p",null,"The tezos-example box is extremely useful for the deployment of a decentralized application (dapp)."),(0,o.kt)("p",null,"This box can be retrieved with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"$ mkdir tezos-example\n$ cd tezos-example\n$ truffle unbox tezos-example\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("em",{parentName:"p"},"Truffle")," unbox command will not create a new tezos-example folder, but will unpack all the content in the current\nfolder."),(0,o.kt)("h2",{id:"using-truffle"},"Using ",(0,o.kt)("em",{parentName:"h2"},"Truffle")),(0,o.kt)("p",null,"Using ",(0,o.kt)("em",{parentName:"p"},"Truffle")," can be divided into two steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Configuration: modifying scripts to define the way smart contracts are deployed."),(0,o.kt)("li",{parentName:"ol"},"Compilation and deployment, with the ",(0,o.kt)("em",{parentName:"li"},"Truffle Cli"))),(0,o.kt)("h3",{id:"project-structure-overview"},"Project Structure overview"),(0,o.kt)("p",null,"A ",(0,o.kt)("em",{parentName:"p"},"Truffle")," follows this structure:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"build")," (not present at the unpacking of the box) : the folder containing the Michelson code, compiled by ",(0,o.kt)("em",{parentName:"li"},"Truffle"),"\nand used for the contracts deployment"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"contract"),": the folder containing all the Ligo smart contracts that ",(0,o.kt)("em",{parentName:"li"},"Truffle")," has to compile."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"migrations"),": the folder containing the ",(0,o.kt)("em",{parentName:"li"},"Truffle")," migration scripts for the deployment of the contrat"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"node_modules"),": the node modules used by the ",(0,o.kt)("em",{parentName:"li"},"Truffle")," project"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"package.json"),": contains a script command, which launches a sandbox with ganache"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"scripts"),":",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"sandbox: contains two accounts to use on a sandbox environment."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"test"),": folder containing Javascript tests"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"truffle-config.js"),": configuration file which defines networks and accounts used for the deployment")),(0,o.kt)("p",null,"The build folder will be created or compiled after any compilation command."),(0,o.kt)("h3",{id:"main-truffle-commands"},"Main ",(0,o.kt)("em",{parentName:"h3"},"Truffle")," commands"),(0,o.kt)("p",null,"The ",(0,o.kt)("em",{parentName:"p"},"Truffle")," Cli provides various commands, that can be displayed with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"$ truffle --help\n")),(0,o.kt)("p",null,"The main commands are:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"compile   Compile contract source files\ninit      Initialize new and empty project\nmigrate   Run migrations to deploy contracts\nnetworks  Show addresses for deployed contracts on each network\ntest      Run JavaScript and Solidity tests\n")),(0,o.kt)("h3",{id:"compiling-smart-contracts-with-truffle"},"Compiling smart contracts with ",(0,o.kt)("em",{parentName:"h3"},"Truffle")),(0,o.kt)("p",null,"In this part, the ",(0,o.kt)("em",{parentName:"p"},"tezos-example")," box is used as example."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," is mainly used for the smart contract compilation and deployment. It can also launch tests, but it is\nrecommended to use a more complete tool, such as pytezos."),(0,o.kt)("p",null,"Compiling smart contracts can easily be done with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"$ truffle compile\n")),(0,o.kt)("p",null,"Input: valid smart contracts (i.e compiling smart contracts), located in contract "),(0,o.kt)("p",null,"Output: ",(0,o.kt)("em",{parentName:"p"},"Truffle")," artifacts, stored into the build/contracts directory."),(0,o.kt)("h4",{id:"ligo-smart-contracts"},"Ligo smart contracts"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," can compile LIGO smart contracts (PascaLigo,Cameligo, ReasonLigo). They MUST be stored in the ",(0,o.kt)("em",{parentName:"p"},"contract")," folder.\n",(0,o.kt)("em",{parentName:"p"},"Truffle")," consider each ligo file as a independant smart contract. Thus, if a smart contract is split into several ligo\nfiles, ",(0,o.kt)("em",{parentName:"p"},"Truffle")," will try to compile each file as a smart contract, resulting in a failed compilation. There is a\nworkaround this behaviour:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create a new folder in the project root directory, called src for instance."),(0,o.kt)("li",{parentName:"ol"},"Move all you smart contracts files into src/"),(0,o.kt)("li",{parentName:"ol"},"Create a ligo file, importing the main file from src/")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," will successfully compile your smart contract."),(0,o.kt)("h4",{id:"truffle-artifacts"},(0,o.kt)("em",{parentName:"h4"},"Truffle")," artifacts"),(0,o.kt)("p",null,"For each ligo file found in contract, ",(0,o.kt)("em",{parentName:"p"},"Truffle")," will yield an artifact in build/contrats."),(0,o.kt)("p",null,"An artifact is a json file, containing the compiled smart contract, the ligo source code, the deployment information...\nThis example is the artifact yielded for the Counter.ligo file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json5"},'{\n  "contractName": "Counter",\n  "abi": [],\n  "michelson": "<Michelson code as json>",\n  "source": "<Content of the ligo file from contract>",\n  "sourcePath": "path/to/truffle-example/contracts/Counter.ligo",\n  "compiler": {\n    "name": "ligo",\n    "version": "next"\n  },\n  "networks": {},\n  "schemaVersion": "3.2.0-tezos.1",\n  "updatedAt": "2021-03-19T14:27:16.197Z"\n}\n')),(0,o.kt)("p",null,"These artifacts are then used in the deployment scripts."),(0,o.kt)("h3",{id:"deploying-smart-contracts-with-truffle"},"Deploying smart contracts with ",(0,o.kt)("em",{parentName:"h3"},"Truffle")),(0,o.kt)("p",null,"At this point, the smart contract is compiled and ready to be deployed. However, ",(0,o.kt)("em",{parentName:"p"},"Truffle")," needs to be configured: deployment on the right network,\nwith the right account, with the right initial storage..."),(0,o.kt)("h4",{id:"using-an-account-for-the-deployment"},"Using an account for the deployment"),(0,o.kt)("p",null,"Originating a contract costs some tz. Thus, an account holding funds is necessary. Accounts with funds on testnets (\ndelphinet, edonet...) can be freely retrieved as a json file here:\n","[https://faucet.tzalpha.net/]"),(0,o.kt)("h4",{id:"adding-a-network"},"Adding a network"),(0,o.kt)("p",null,"The network configuration is handled in the truffle-config.js file. It can execute any javascript code needed for the\nconfiguration. Some networks are already defined (mainnet, localhost). However, as the tezos protocol is likely to evolve,\nnew networks will probably have to be added. A network is associated to an account. The easiest way is to use an\naccount from a faucet."),(0,o.kt)("p",null,"There are two ways of importing an account:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Importing an account into the truffle-config.js file:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const {mnemonic, secret, password, email} = require("/path/to/faucet.json");\n')),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," will activate this account, along with the origination."),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Setting ",(0,o.kt)("strong",{parentName:"li"},"already activated")," accounts in the scripts folder:\nAccounts can be defined according to the network. By default, a ",(0,o.kt)("em",{parentName:"li"},"sandbox")," folder is present, with two defined acocunts (\nthese two accounts are found in any sandbox). New accounts can be defined by creating a new folder, whose name is the\nnetwork name (convention), with an accounts.js file:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'module.exports = {\n    account_name: {\n        pkh: "<pkh>",\n        sk: "<sk>",\n        pk: "<pk>"\n    },\n<...>\n};\n')),(0,o.kt)("p",null,"Of course, the faucet can be imported in the ",(0,o.kt)("em",{parentName:"p"},"accounts.js")," file."),(0,o.kt)("p",null,"The truffle-config.js file must export an object, defining networks."),(0,o.kt)("p",null,"Adding the edonet network into the truffle-config.js file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const {alice} = require(\'./scripts/sandbox/accounts\');\nconst {mnemonic, secret, password, email} = require("/path/to/faucet.json");\n\nmodule.exports = {\n    networks: {\n        development: {\n            host: "http://localhost",\n            port: 8732,\n            network_id: "*",\n            secretKey: alice.sk,\n            type: "tezos"\n        },\n        edonet: {\n            host: "https://edonet-tezos.giganode.io",\n            port: 443,\n            network_id: "*",\n            secret,\n            mnemonic,\n            password,\n            email,\n            type: "tezos"\n        },\n        [...]\n}\n}\n;\n\n')),(0,o.kt)("p",null,"Each key in ",(0,o.kt)("em",{parentName:"p"},"networks")," sets a network. An RPC node (","[https://tezostaquito.io/docs/rpc_nodes/]",") or a local node (as shown\nin the development network) can be specified, along with the port."),(0,o.kt)("h4",{id:"writing-the-migration-scripts"},"Writing the migration scripts"),(0,o.kt)("p",null,"The smart contracts are ready, the network where it has to be deployed too, the next step is to write the deployment\nscript (also called a migration). These scripts are located in the ",(0,o.kt)("em",{parentName:"p"},"migrations")," directory. Each migration is a\njavascript file, defining the deployment tasks. It can execute any javascript code. Each migration starts with a number,\nfollowed by a title: ",(0,o.kt)("em",{parentName:"p"},"Truffle")," runs the migrations in the ascending order. For example, the tezos-example box comes with\ntree migrations:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"1_initial_migration.js\n2_deploy_simple_storage.js\n3_deploy_counter.js\n")),(0,o.kt)("p",null,"A migration defines:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"the initial storage"),(0,o.kt)("li",{parentName:"ul"},"how the contracts are deployed: order, networks, accounts")),(0,o.kt)("h5",{id:"importing-the-smart-contract-to-deploy"},"Importing the smart contract to deploy"),(0,o.kt)("p",null,"The first step is to specify which smart contract is to be deployed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var myContract = artifacts.require("MyContract");\n')),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Truffle")," will look for a ",(0,o.kt)("em",{parentName:"p"},"MyContract.ligo")," file in the ",(0,o.kt)("em",{parentName:"p"},"contracts")," directory. Thus, to import a contract, the filename of\nthe contract (without the extension) is used. artifacts is a ",(0,o.kt)("em",{parentName:"p"},"Truffle")," keyword. It is possible to import several smart\ncontracts:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var firstContract = artifacts.require("FirstContract");\nvar secondContract = artifacts.require("SecondContract");\n')),(0,o.kt)("h5",{id:"defining-the-initial-storage"},"Defining the initial storage"),(0,o.kt)("p",null,"A smart contract is likely to have a storage. When it is originated, the initial storage must be set. This contract must\nbe compliant with the structure defined in the smart contract to deploy: the names and types must be respected. The\ninitial storage is declared with a Javascript syntax. Two modules can come in handy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const {MichelsonMap} = require("@taquito/taquito");\nconst web3 = require("web3");\n')),(0,o.kt)("p",null,"Below is the matching table between Javascript and Ligo."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Ligo"),(0,o.kt)("th",{parentName:"tr",align:null},"Javascript"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"List, Tuple"),(0,o.kt)("td",{parentName:"tr",align:null},"[ ]")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Big_map, Map"),(0,o.kt)("td",{parentName:"tr",align:null},"const bigMap = new MichelsonMap() ",(0,o.kt)("br",null)," bigMap.set(key, values) ",(0,o.kt)("br",null)," ",(0,o.kt)("em",{parentName:"td"},"(from taquito module)"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"string, address"),(0,o.kt)("td",{parentName:"tr",align:null},"string")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"bytes"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"web3.utils.asciiToHex(string_to_convert).slice(2)"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"int, nat, mutez"),(0,o.kt)("td",{parentName:"tr",align:null},"number")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"record"),(0,o.kt)("td",{parentName:"tr",align:null},"Object { }")))),(0,o.kt)("p",null,"Here is a migration example, defining a storage with essential types:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// modules import\nconst {MichelsonMap} = require("@taquito/taquito"); // used for big maps\nconst web3 = require("web3"); // used for bytes\n\n// contract to deploy\nvar MyContract = artifacts.require("MyContract");\n\n// initial storage definition\nconst admin = "tz1ibMpWS6n6MJn73nQHtK5f4ogyYC1z9T9z"; //address\nconst emptyBigMap = new MichelsonMap(); // empty big map\nconst bigMapWithAnElement = new MichelsonMap(); // empty big map\nbigMapWithAnElement.set(\n    1, {\n        param1: 5,\n        param2: "second param"\n    }\n); // previous big map with a object (record in ligo) as value, and an int as key\nconst emptySet = []; // empty set\nconst myBytes = web3.utils.asciiToHex("string to convert into bytes").slice(2); // bytes\nconst counter = 10; // int\n\nconst initialStorage = {\n    "contractAdmin": admin,\n    "contractFirstBigMap": emptyBigMap,\n    "contractSecondBigMap": bigMapWithAnElement,\n    "contractSet": emptySet,\n    "contractCounter": metadata,\n};\n')),(0,o.kt)("p",null,"Any type and structure change in the Ligo smart contract storage must be mirrored here, in the ",(0,o.kt)("em",{parentName:"p"},"initialStorage")," variable.\nThis way, the evolution of the storage used can be versioned."),(0,o.kt)("h5",{id:"deployment"},"Deployment"),(0,o.kt)("p",null,"The last step of the migration is the deployment definition. It is a function export, which defines how the contract(s)\nshould be deployed. This function takes 3 arguments:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"deployer: truffle object which deploys a contract"),(0,o.kt)("li",{parentName:"ul"},"network: the network used"),(0,o.kt)("li",{parentName:"ul"},"account: the account used")),(0,o.kt)("h6",{id:"deployer"},"Deployer"),(0,o.kt)("p",null,"The deployer object deploys the code on the specified ",(0,o.kt)("em",{parentName:"p"},"network"),". The deployer takes as input the initialStorage object (\nand a few options)."),(0,o.kt)("p",null,"A minimal viable migration can be:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var MyContract = artifacts.require("MyContract");\nconst initialStorage = {}\nmodule.exports = (deployer, network, account) => {\n    // deployment steps\n    deployer.deploy(MyContract, initialStorage);\n};\n')),(0,o.kt)("p",null,"The execution returns some pieces of information (such as the contract address, the cost ...)"),(0,o.kt)("h6",{id:"network"},"Network"),(0,o.kt)("p",null,"It can be useful to deploy a smart contract differently according to the network.\nFor instance, if the storage holds an administator address, it is very likely to be different on the mainnet and testnet\nThe migration can be branched according to the network like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var MyContract = artifacts.require("MyContract");\nconst edonetInitialStorage = {}\nconst mainnetInitialStorage = {}\nmodule.exports = (deployer, network, account) => {\n    if (network === "edonet") {\n        deployer.deploy(MyContract, edonetInitialStorage);\n    } else {\n        deployer.deploy(MyContract, mainnetInitialStorage);\n    }\n\n};\n')),(0,o.kt)("p",null,"The deployment changes accordingly to the network used. Here, the storage is not the same."),(0,o.kt)("h6",{id:"account"},"Account"),(0,o.kt)("p",null,"The account used for the migration can be handled during the migration."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var MyContract = artifacts.require("MyContract");\nconst initialStorage = {admin: "tz1ibMpWS6n6MJn73nQHtK5f4ogyYC1z9T9z"}\nmodule.exports = (deployer, network, account) => {\n    deployer.deploy(MyContract, {...initialStorage, admin: account[0]});\n\n};\n')),(0,o.kt)("p",null,"This example sets the migration account as the contract administrator."),(0,o.kt)("h6",{id:"migrate-several-contracts"},"Migrate several contracts"),(0,o.kt)("p",null,"A migration can deploy several contracts at the same time.\nIt is useful when the migration data have to be used in another contract deployment.\nBelow, there is an example with two contracts. The second contract needs to call the first, and needs its address."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var firstContract = artifacts.require("firstContract");\nvar secondContract = artifacts.require("secondContract");\nconst initialStorage = {admin: "tz1ibMpWS6n6MJn73nQHtK5f4ogyYC1z9T9z", contractToCall: ""}\nmodule.exports = (deployer, network, account) => {\n    deployer.deploy(firstContract).then(function () {\n        return deployer.deploy(secondContract,\n            {\n                ...initialStorage,\n                contractToCall: firstContract.address\n            });\n    });\n\n};\n')),(0,o.kt)("h4",{id:"running-a-migration"},"Running a migration"),(0,o.kt)("p",null,"Everything is now ready for the deployment: the network and the migration account are set, the initial storage and the deployment step are defined.\nFrom the project directory, run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ truffle migrate --network <network_name>\n")),(0,o.kt)("p",null,"This command launches two steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Verifying that the smart contracts are compiled. If they are not, it will launch a compilation"),(0,o.kt)("li",{parentName:"ol"},"Deploying the smart contracts according the migration under the ",(0,o.kt)("em",{parentName:"li"},"migration")," folder. Before the deployment, ",(0,o.kt)("em",{parentName:"li"},"Truffle")," checks if the initial storage is compliant with its Michelson definition. If not, it will raise an exception")),(0,o.kt)("p",null,"Each migration generally takes up to 30 seconds. At the end, several pieces of information are displayed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"1_initial_migration.js\n======================\n\n    Deploying 'Migrations'\n----------------------\n> operation hash:      ooWVHFdjJbvGYDp9CUhUzonRfobvnHExzqsZBQmbEHpmcuveh6Q\n> Blocks: 0            Seconds: 16\n> contract address:    KT18uWmKP5gTVh7FKHwRRwjE6XVAsm7WLHSF\n> block number:        137896\n> block timestamp:     2021-04-02T08:28:05Z\n> account:             tz1YWK1gDPQx9N1Jh4JnmVre7xN6xhGGM4uC\n> balance:             53167.468776\n> gas used:            2012\n> storage used:        154 bytes\n> fee spent:           0.645 mtz\n> burn cost:           0.10275 tez\n> value sent:          0 XTZ\n> total cost:          0.103395 XTZ\n\n\n> Saving migration to chain.\n> Saving artifacts\n-------------------------------------\n> Total cost:            0.103395 XTZ\n")),(0,o.kt)("p",null,"The most useful piece of information are the contract address (to interact with it) and the transaction hash (which refers to the origination on the blockchain). "),(0,o.kt)("p",null,"Some of these pieces of information can be found into the json file under the build/contracts folder"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{\n"contractName": "Migrations",\n"abi": [],\n"michelson": "<michelson_code>",\n"source": "<ligo_code>",\n"sourcePath": "/path/to/contracts/Migrations.ligo",\n"compiler": {\n"name": "ligo",\n"version": "next"\n},\n"networks": {\n"NetXSgo1ZT2DRUG": {\n"events": {},\n"links": {},\n"address": "KT18uWmKP5gTVh7FKHwRRwjE6XVAsm7WLHSF",\n"transactionHash": "ooWVHFdjJbvGYDp9CUhUzonRfobvnHExzqsZBQmbEHpmcuveh6Q"\n}\n},\n"schemaVersion": "3.2.0-tezos.1",\n"updatedAt": "2021-04-02T08:29:37.743Z",\n"networkType": "tezos"\n}\n')),(0,o.kt)("h3",{id:"interacting-with-a-deployed-contract"},"Interacting with a deployed contract"),(0,o.kt)("p",null,"Once the migration is done, it can be convenient to quickly check that the contract is really deployed.\nThere many tools for this: cli, libraries, GUI... In this section, we'll keep it simple with a GUI. "),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://tzstats.com/"},"tzstats.com")," provides information about any public tezos network: transactions, accounts, contracts (origination, storage, entrypoints)..."),(0,o.kt)("p",null,"Once a contract is deployed, it can be checked here (on edonet): ",(0,o.kt)("a",{parentName:"p",href:"https://edo.tzstats.com/"},"https://edo.tzstats.com/"),'<contract_address>.\nYou should see a "New Smart contract created by ..." line in the ',(0,o.kt)("em",{parentName:"p"},"Calls")," section. The contract storage can also be inspected."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"Scheme to come..."))}p.isMDXComponent=!0}}]);