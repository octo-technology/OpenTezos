<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenTezos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenTezos Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">Smart contract development in PascaLIGO | OpenTezos</title><meta data-react-helmet="true" property="og:url" content="https://opentezos.com/ligo/write-contracts-ligo"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Smart contract development in PascaLIGO | OpenTezos"><meta data-react-helmet="true" name="description" content="The language used in smart contracts on Tezos is Michelson, a stack-based language. However, this kind of language is not commonly used by developersa and as the code becomes complex and longer, it grows increasingly harder to keep readable and clean code in Michelson. However, the Tezos ecosystem provides some high-level languages alternatives, which make smart contracts development as easy as any application development."><meta data-react-helmet="true" property="og:description" content="The language used in smart contracts on Tezos is Michelson, a stack-based language. However, this kind of language is not commonly used by developersa and as the code becomes complex and longer, it grows increasingly harder to keep readable and clean code in Michelson. However, the Tezos ecosystem provides some high-level languages alternatives, which make smart contracts development as easy as any application development."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://opentezos.com/ligo/write-contracts-ligo"><link data-react-helmet="true" rel="alternate" href="https://opentezos.com/ligo/write-contracts-ligo" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://opentezos.com/ligo/write-contracts-ligo" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.60c2ec83.css">
<link rel="preload" href="/assets/js/runtime~main.972b4ff9.js" as="script">
<link rel="preload" href="/assets/js/main.6ca66676.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="OpenTezos" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-dark.svg" alt="OpenTezos" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/octo-technology/OpenTezos/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT" style="margin-left:2px">üåô</span></div><div class="react-toggle-track-x"><span class="toggle_71bT" style="margin-left:1px">‚òÄÔ∏è</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="OpenTezos" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-dark.svg" alt="OpenTezos" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/octo-technology/OpenTezos/" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Welcome</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/">Modules</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/paths">Paths</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Blockchain Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blockchain-basics">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blockchain-basics/main-properties">Main properties of the first &quot;blockchain&quot;</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blockchain-basics/proof-of-work">Proof-of-work</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blockchain-basics/other-consensuses">Introduction to other consensus algorithms</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blockchain-basics/smart-contracts">Smart Contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blockchain-basics/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tezos Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/smart-contracts">Smart contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/liquid-proof-of-stake">Liquid Proof-of-Stake</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/operations">Operations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/cli-and-rpc">CLI and RPC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/governance-on-chain">Governance on-chain</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/history-of-amendments">History of amendments</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/economics-and-rewards">Economics and rewards</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tezos-basics/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploy a node</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploy-a-node">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploy-a-node/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploy-a-node/set-up-a-node">Set-up a node</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploy-a-node/networks">What about networks?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploy-a-node/to-go-further">To go further</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploy-a-node/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">How to use an Explorer</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer/indexer-explained">How Indexers Work?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer/available-tezos-indexers">Available Tezos Explorers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer/tzstats-main-features">How to use the tzStats blockchain explorer?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer/tzstats-smart-contract">Checkout your smart contract on TzStats</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer/private-indexer">Private indexer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/explorer/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">SmartPy</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/smartpy">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/smartpy/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/smartpy/write-contract-smartpy">Smart contract development with SmartPy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/smartpy/exam">Exam</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">LIGO</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/installation">Installation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/ligo/write-contracts-ligo">Smart contract development in PascaLIGO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/language-basics">Language basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/deploy-a-contract">Smart Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/unit-testing">Unit Testing with PyTezos</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/examples">Examples</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/exam">Exam</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ligo/take-away">Take Away</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Michelson</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson/smart-contracts">Smart Contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson/tutorial">Tutorial</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson/examples">Examples</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson/instructions-reference">Instructions Reference</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson/exam">Exam</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/michelson/take-away">Take away</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Build a Dapp</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp/truffle_compilation_migration">Smart contract deployment with Truffle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp/taquito">Taquito</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp/temple">Temple Wallet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp/basics">Build a dapp - basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp/front_user_experience">Build a dapp - User Experience</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/dapp/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Baking</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baking">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baking/baking_explained">How baking works?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baking/reward">Rewards</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baking/bakers_list">List of bakers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baking/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploy Bakers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baker">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baker/cli-baker">CLI to become a baker</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baker/delegating">Delegating</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baker/voting">Voting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/baker/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">DeFi</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/token-standards">Token Standards</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/dexs">Decentralized Exchanges</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/wrapped-assets">Wrapped Assets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/cross-chain-swaps">Cross-chain Swaps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/oracles">On-chain Oracles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/stablecoins">Stablecoins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/synthetics">Synthetics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/lending">Lending and Flash Loans</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/defi/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Formal Verification</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/formal-verification">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/formal-verification/gadt-coq">Coq, GADT and Mi-Cho-Coq</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/formal-verification/modeling-theorem">Formal verification on smart contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/formal-verification/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Private Blockchain</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/private">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/private/exam">Exam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">How to contribute</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute/report-issue">Report an issue</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute/opentezos">Contribute to OpenTezos</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute/tezos-core">Contribute to the Tezos Core Protocol</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute/grant">Receive a grant</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute/baker">Become a baker or a delegator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contribute/exam">Exam</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Smart contract development in PascaLIGO</h1></header><div class="markdown"><p>The language used in smart contracts on Tezos is <a href="/michelson/introduction">Michelson</a>, a stack-based language. However, this kind of language is not commonly used by developersa and as the code becomes complex and longer, it grows increasingly harder to keep readable and clean code in Michelson. However, the Tezos ecosystem provides some high-level languages alternatives, which make smart contracts development as easy as any application development.
LIGO is one of these languages.</p><p>In this chapter, we will focus on smart contract development with LIGO language (and particularly the PascaLigo syntax of the LIGO language). The most important aspects of Ligo will be covered here.
If you want to learn the complete LIGO syntax, you can take a look at:</p><ol><li><a href="https://ligolang.org/docs/intro/introduction" target="_blank" rel="noopener noreferrer">The official Ligolang documentation</a>: a complete reference maintained by the developing team.</li><li><a href="https://tezosacademy.io/" target="_blank" rel="noopener noreferrer">Tezos academy</a>: courses with examples that cover all the LIGO syntax. The first twenty chapters will teach you the basic aspects of the syntax.</li></ol><p>This chapter has been written with a smart contract development approach. Each part starts with an explanation of the LIGO syntax (called &quot;LIGO prerequisite sections&quot;) that are later used for smart contract development.</p><p>The &quot;LIGO prerequisite&quot; parts can be skipped if you do not need to learn the PascaLIGO syntax.</p><div class="root_2W3B"><p><b>DISCLAIMER: this smart contract is meant for educational purpose only, and is not suitable for any other use. OpenTezos cannot be held responsible for any other use.</b></p></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="raffle-smart-contract"></a>Raffle smart contract<a class="hash-link" href="#raffle-smart-contract" title="Direct link to heading">#</a></h2><p>In this chapter, a simple <a href="https://en.wikipedia.org/wiki/Raffle" target="_blank" rel="noopener noreferrer">raffle</a> example is considered. A raffle is a gambling game, where players buy tickets. The winning ticket is then drawn. In our case, a raffle will be developed in a smart contract with those rules: </p><ul><li>An address (called the administrator) wants to organize a raffle, whose reward is a tz amount.</li><li>The administrator pays the reward to the winner with their own funds. </li><li>Anyone can participate in the raffle, and the participation fee is the same for everyone. However, each address can participate only once.</li><li>Each ticket has the same probability of being picked.</li><li>And after a given time, defined at the beginning of the raffle, the administrator will close the raffle, and rewards the winner.</li></ul><p>This raffle can be divided into three steps:</p><ol><li>a raffle is opened, with a reward, for a given time</li><li>during the raffle time, anyone can buy a raffle ticket.</li><li>the raffle is closed, the winner is randomly selected and rewarded with the prize.</li></ol><p>Only one raffle session can be ongoing.</p><blockquote><p>Some choices have been made for educational purposes.</p></blockquote><div class="root_2W3B"><p><b>About the word &quot;ticket&quot; :</b>ticket is a reserved word in Michelson and Ligo, introduced by the Edo protocol. In this chapter, the word &quot;ticket&quot; only refers to a raffle ticket.</p></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="prerequisites-for-smart-contracts-development"></a>Prerequisites for smart contracts development<a class="hash-link" href="#prerequisites-for-smart-contracts-development" title="Direct link to heading">#</a></h2><p>When developing smart contracts, two tools are extremely useful:</p><ol><li>a Ligo syntax support for your IDE</li><li>a Ligo compiler</li></ol><p>These two tools will point out syntax errors and type-checking errors. However, it is recommended to compile a ligo smart contract as often as possible. The compilation will detect errors that the IDE linter won&#x27;t. Thus, errors will be found early and should be more easily be addressed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="smart-contract-initialization"></a>Smart contract initialization<a class="hash-link" href="#smart-contract-initialization" title="Direct link to heading">#</a></h2><blockquote><p>LIGO concepts used in this part: everything that is required to create an empty smart contract.</p><ul><li>Types, built-in types</li><li>Constants, Variables</li><li>Introduction to functions</li><li>main function</li><li>ligo compilation</li></ul></blockquote><p>A Michelson smart contract defines three pieces of information:</p><ol><li><strong>parameter</strong>: possible invocations of the smart contract</li><li><strong>storage</strong>: persistent data structure, on-chain.
This can be read by everyone, but can only be changed by the contract itself.</li><li><strong>code</strong>: a sequence of instructions to be executed when invoking a smart contract</li></ol><p>These three pieces of information must also be defined in the Ligo code.</p><p>The first step is to create a .ligo file.
Let&#x27;s create a file called raffle.ligo, which will compile a &#x27;minimum&#x27; but viable contract.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ligo-concepts-used-in-this-part"></a>LIGO concepts used in this part<a class="hash-link" href="#ligo-concepts-used-in-this-part" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="types"></a>Types<a class="hash-link" href="#types" title="Direct link to heading">#</a></h4><p>LIGO is strongly and statically typed. This means that the compiler checks how a contract processes data, ensuring that each function&#x27;s expectations are met.
If it passes the test, the contract will not fail at run-time due to some inconsistent assumptions on the data. This is called type checking.</p><p>LIGO types are built on top of Michelson&#x27;s type system.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="built-in-types"></a>Built-in types<a class="hash-link" href="#built-in-types" title="Direct link to heading">#</a></h5><p>LIGO supports all Michelson types, from basic primitives (such as <code>string</code> or <code>int</code>) to composites types (such as <code>option</code>, <code>list</code> or <code>map</code>), including contract-specific types (such as <code>address</code> or <code>tez</code>).</p><p>You can find all built-in types on the <a href="https://gitlab.com/ligolang/ligo/-/tree/dev#L35" target="_blank" rel="noopener noreferrer">LIGO gitlab</a>.</p><p>Below is a table of the most used built-in types. Most of them will be used in the raffle smart contract:</p><table><thead><tr><th>Type</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td><code>unit</code></td><td>carries no information</td><td><code>Unit</code></td></tr><tr><td><code>option</code></td><td>value of some type or none</td><td><code>Some (&quot;this string is defined&quot;)</code>, <code>(None: option string)</code></td></tr><tr><td><code>string</code></td><td>Sequence of character</td><td><code>&quot;This is a string&quot;</code></td></tr><tr><td><code>address</code></td><td>Address of an implicit account</td><td><code>(&quot;tz1KqTpEZ7Yob7QbPE4Hy4Wo8fHG8LhKxZSx&quot; : address)</code></td></tr><tr><td><code>int</code></td><td>Positive or negative integer</td><td><code>-5</code>, <code>int (1n)</code></td></tr><tr><td><code>nat</code></td><td>Positive integer</td><td><code>0n</code>, <code>abs (1)</code></td></tr><tr><td><code>tez</code>, <code>tz</code>, <code>mutez</code></td><td>Amount in tz or mutez</td><td><code>5mutez</code>, <code>10tez</code></td></tr><tr><td><code>bool</code></td><td>Boolean: true or false</td><td><code>True</code>, <code>False</code></td></tr><tr><td><code>timestamp</code></td><td>Timestamp (bakers are responsible for providing the given current timestamp)</td><td><code>(&quot;2000-01-01T10:10:10Z&quot; : timestamp)</code>, <code>Tezos.now</code></td></tr><tr><td><code>bytes</code></td><td>Sequence of bytes</td><td>0x12e4</td></tr><tr><td><code>list (type)</code></td><td>List definition. The same element can be found several times in a list</td><td><code>list [1; 2; 2]</code>, <code>nil</code></td></tr><tr><td><code>set (type)</code></td><td>Set definition. The same element cannot be found several times in a list</td><td><code>set []</code>, <code>set [3; 2; 2; 1]</code></td></tr><tr><td><code>type1 * type2 ... * typeN</code></td><td>Tuple definition</td><td><code>(&quot;Alice&quot;, 5n, True)</code></td></tr><tr><td><code>(keyType, valueType) map</code></td><td>Map an element of type keyType to an element of type valueType. Meant for finite maps</td><td><code>Map.empty</code>, <code>Map.literal [((&quot;tz1KqTpEZ7Yob7QbPE4Hy4Wo8fHG8LhKxZSx&quot; : address), (1,2)); ((&quot;tz1gjaF81ZRRvdzjobyfVNsAeSC6PScjfQwN&quot; : address), (0,3))]</code></td></tr><tr><td><code>(keyType, valueType) big_map</code></td><td>Map an element of type keyType to an element of type valueType. Meant for huge maps</td><td><code>Big_map.empty</code>, <code>Big_map.literal [((&quot;tz1KqTpEZ7Yob7QbPE4Hy4Wo8fHG8LhKxZSx&quot; : address), (1,2)); ((&quot;tz1gjaF81ZRRvdzjobyfVNsAeSC6PScjfQwN&quot; : address), (0,3))]</code></td></tr></tbody></table><blockquote><p>As you may have noticed, there is no <code>float</code> type. Indeed, <code>float</code> is not deterministic and depend on the hardware that runs the node.</p></blockquote><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="type-aliases"></a>Type aliases<a class="hash-link" href="#type-aliases" title="Direct link to heading">#</a></h5><p>Type aliasing consists of renaming a given type when the context calls for a more precise name.</p><p>It can be used to express our intent for more clarity: for instance, a <code>coordinates</code> type defined by a tuple of two integers is clearer than just using a tuple.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type coordinates </span><span class="token function" style="color:rgb(111, 66, 193)">is</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">int </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> int</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> my_position </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> coordinates </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>‚ö†Ô∏è tuples will be explained later.</p><p>It is also useful to define a type for complex structures, such as the expected input and return of a function, or the contract storage.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="constants--variables-declaration"></a>Constants &amp; Variables declaration<a class="hash-link" href="#constants--variables-declaration" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="constants"></a>Constants<a class="hash-link" href="#constants" title="Direct link to heading">#</a></h5><p>Constants are by design immutable, which means they can only be assigned once, at their declaration.
A constant is defined by a name, a type and a value:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> age </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">25</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="variables"></a>Variables<a class="hash-link" href="#variables" title="Direct link to heading">#</a></h5><p>Variables, unlike constants, are mutable. They cannot be declared in a global scope, but they can be declared and used within functions, or as function parameters.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">var</span><span class="token plain"> c</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">c </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> c </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token plain"> </span><span class="token number">3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>‚ö†Ô∏è The assignment operator is different: <code>:=</code> for var, instead of <code>=</code> for constants.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction-to-functions"></a>Introduction to functions<a class="hash-link" href="#introduction-to-functions" title="Direct link to heading">#</a></h4><p>As in any other language, functions can be defined in Ligo. There are several ways to define a function, but the header is always the same:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">functionName</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> param1 </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">param2Type</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> param2 </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">param2Type</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token spread operator" style="color:rgb(0, 92, 197)">...</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">returnType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Functions will be detailed below. At this point, since the main function does nothing, it will use a <a href="/docs/ligo/write-contracts-ligo#blockless-functions">blockless function</a> definition.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="main-function"></a>Main function<a class="hash-link" href="#main-function" title="Direct link to heading">#</a></h4><p>Every LIGO smart contract must define a main function. This main function defines the <strong>code</strong> section of the Michelson code: it creates <em>operations</em> and update the contract <em>storage</em>, depending on the contract parameter.</p><p>It takes two parameters, the <strong>contract parameter</strong> and the <strong>on-chain storage</strong>, and returns a pair made of a <strong>list of operations</strong> and a <strong>(new) storage</strong>. </p><br><p><img src="/assets/images/main_function-def6ca332b38507cc42b237cc24c24fc.svg"></p><small class="figure">FIGURE 1: Main function</small><br><p>The type of the contract parameter and the storage are up to the contract designer, but the type for the list operations is not.</p><p>The return type of &quot;main&quot; function is as follows, assuming that the <code>storage</code> type has been defined elsewhere.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is </span><span class="token spread operator" style="color:rgb(0, 92, 197)">...</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// Any name, any type</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type returnMainFunction is </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ligo-compilation"></a>Ligo compilation<a class="hash-link" href="#ligo-compilation" title="Direct link to heading">#</a></h4><p>The ligo code above should now compile with this command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">$ ligo compile-contract </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">ligoFile</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">mainFunction</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If the compilation is successful, the output will be the Michelson code.</p><p>It is recommended to run this command as often as possible, to check both code syntax and types.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="raffle-storage-initialization"></a>Raffle storage initialization<a class="hash-link" href="#raffle-storage-initialization" title="Direct link to heading">#</a></h3><p>Now that we have introduced some basics LIGO concepts (type, constant, variable, function and last but not least the main function prototype), let&#x27;s design our <em>Raffle</em> smart contract.</p><p>The first step is to define the storage. Contract storage holds the contract data: it can be a single value or a complex structure. The storage definition is a <code>type</code> instruction. First, the storage will be as simple as possible: empty.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is unit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>‚ö†Ô∏è The word <em>unit</em> is a reserved word of the language and represents an <em>empty type</em>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="raffle-parameter-initialization"></a>Raffle parameter initialization<a class="hash-link" href="#raffle-parameter-initialization" title="Direct link to heading">#</a></h3><p>Smart contracts generally have one or several parameters, but it is not mandatory.
At this point, the parameter definition will be skipped. They will be defined later on, in this chapter.
To define a smart contract without any parameter:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is unit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="raffle-code-definition"></a>Raffle code definition<a class="hash-link" href="#raffle-code-definition" title="Direct link to heading">#</a></h3><p>The last piece of information of the smart contract is the code definition. A smart contract can of course execute no instruction, but it must always return two things:</p><ol><li>a list of operations</li><li>the storage</li></ol><p>The ligo compiler expects a smart contract to have at least one function, which is the &quot;main&quot; function. It does not have to be named that way. In this chapter, the &quot;main&quot; function will be named main:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is unit</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is unit</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage </span><span class="token function" style="color:rgb(111, 66, 193)">is</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This main function returns a tuple of the two required elements.</p><p>The raffle smart contract can now be compiled:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">$ ligo compile-contract raffle.ligo main</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summing-up"></a>Summing-up<a class="hash-link" href="#summing-up" title="Direct link to heading">#</a></h3><p>The three Michelson parts have an equivalence in LIGO
| Michelson | LIGO                                                                                                                                     |
| --------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| parameter | <code>type raffleEntrypoints is</code>                                                                                                              |
| storage   | <code>type storage is</code>                                                                                                                        |
| code      | <code>function main (const action : raffleEntrypoints; const store : storage): list (operation) * storage is ((nil: list(operation)), store)</code> |</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="smart-contract-development--launch-raffle-entrypoint"></a>Smart Contract development¬†: launch raffle entrypoint<a class="hash-link" href="#smart-contract-development--launch-raffle-entrypoint" title="Direct link to heading">#</a></h2><blockquote><p>LIGO concepts used in this part:
We are going to add our first entrypoint. We will need to dispatch the control flow in the main function. We are also going to complexify the storage, with new types. Finally, we are going to implement some logic. We are going to check the access rights, raise an exception if they are not respected and finally interact with some part of the Tezos blockchain.</p><ul><li>Record</li><li>Tuples</li><li>functions</li><li>Entrypoint</li><li>variant</li><li>pattern matching</li><li>if condition</li><li>failwith</li><li>types: addresses, timestamp</li><li>Tezos Module</li></ul></blockquote><p>The LIGO code is compiling, but the Michelson code does nothing:  there is an empty storage, no parameter, and the smart contract returns an empty list of operation and an empty storage. As detailed in the <a href="#raffle-smart-contract">Raffle smart contract</a> section, the smart contract should perform three actions:</p><ol><li>launch a raffle</li><li>sell tickets (which that the caller can buy a ticket)</li><li>close the raffle, and reward the winner</li></ol><p>Each one of these actions can be coded into an entrypoint.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ligo-concepts-used-in-this-part-1"></a>LIGO concepts used in this part<a class="hash-link" href="#ligo-concepts-used-in-this-part-1" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="records"></a>Records<a class="hash-link" href="#records" title="Direct link to heading">#</a></h4><p>The record` type is a structure that holds several pieces of information: each piece is referenced thanks to a field name.</p><p>Records are used:</p><ul><li>for the storage definition </li><li>for any object that should hold different types of information.</li></ul><p>For more details about <code>record</code>, see <a href="https://ligolang.org/docs/language-basics/maps-records#records" target="_blank" rel="noopener noreferrer">Ligolang records documentation</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="tuples"></a>Tuples<a class="hash-link" href="#tuples" title="Direct link to heading">#</a></h4><p>Tuples gather multiple fields into a single structure. A tuple data structure is ordered, which means we can access each element of the tuple by its position. Unlike <code>record</code> type, the tuple fields are unnamed.</p><p>Tuples are used:</p><ul><li>for the return type of the <strong>main</strong> function</li><li>for ordered data structures </li></ul><p>For more details about <code>tuple</code>, see <a href="https://ligolang.org/docs/language-basics/sets-lists-tuples#tuples" target="_blank" rel="noopener noreferrer">Ligolang <code>tuple</code> documentation</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conditional-branching"></a>Conditional branching<a class="hash-link" href="#conditional-branching" title="Direct link to heading">#</a></h4><p>There are two ways to write <code>if</code> conditions:</p><ol><li>For a single expression logic</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">isSmall</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> n </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> n </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> </span><span class="token number">10n</span><span class="token plain"> then </span><span class="token boolean" style="color:rgb(0, 92, 197)">true</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(0, 92, 197)">false</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li>For a block expression logic: </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> y then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> z </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  x </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> y </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> z</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> skip</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For more details about <code>if</code> conditions, see <a href="https://ligolang.org/docs/language-basics/boolean-if-else#conditionals" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/language-basics/boolean-if-else#conditionals</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="error-handling"></a>Error handling<a class="hash-link" href="#error-handling" title="Direct link to heading">#</a></h4><p>A smart contract can raise an exception, that will stop the smart contract execution, with the use of the keyword <code>failwith</code> (with an error message):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">string_message</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For more details about <code>failwith</code>, see <a href="https://ligolang.org/docs/language-basics/exceptions" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/language-basics/exceptions</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="interactions-with-a-tezos-network-tezos-module"></a>Interactions with a Tezos network: Tezos Module<a class="hash-link" href="#interactions-with-a-tezos-network-tezos-module" title="Direct link to heading">#</a></h4><p>The Tezos module is a set of LIGO instructions, that query the state of the Tezos blockchain.
It is useful when the smart contract needs to know who is calling an entrypoint, to send a transaction, if enough funds have been transferred ect...</p><ul><li><code>Tezos.balance</code>: Get the balance for the contract.</li><li><code>Tezos.amount</code>: Get the amount of tez provided by the sender to complete this transaction.</li><li><code>Tezos.sender</code>: Get the address that initiated the current transaction.</li><li><code>Tezos.self_address</code>: Get the address of the currently running contract.</li><li><code>Tezos.source</code>: Get the originator (address) of the current transaction.
That is, if a chain of transactions led to an execution, you get the address that began the chain.
Not to be confused with Tezos.sender,
which gives the address of the contract or user which directly caused the current transaction.</li><li><code>Tezos.chain_id</code>: Get the identifier of the chain to distinguish between main and test chains.</li><li><code>Tezos.transaction</code>: create a transaction, that will be sent at the end of the contract execution. See more <a href="/docs/ligo/write-contracts-ligo#ligo-concepts-used-in-this-part-transactions">later</a></li></ul><p>For more details about the <code>failwith</code> instruction, see <a href="https://ligolang.org/docs/reference/current-reference" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/reference/current-reference</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="functions-in-ligo"></a>Functions in ligo<a class="hash-link" href="#functions-in-ligo" title="Direct link to heading">#</a></h4><p>LIGO functions are the basic building block of contracts. Each entrypoint of a contract executes a function and each smart contract must have at least one <strong>main</strong> function that dispatches the control flow to other functions.</p><p>When calling a function, LIGO makes a copy of the arguments but also of the environment variables.</p><p>Therefore, any modification to these will not be reflected outside the scope of the function and will be lost if they are not explicitly returned by the function.</p><p>There are two syntaxes for functions in PascaLIGO, Block Functions and Blockless Functions:</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="block-functions"></a>Block functions<a class="hash-link" href="#block-functions" title="Direct link to heading">#</a></h5><p>Block functions in PascaLIGO are defined using the following syntax:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">parameters</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">return_type</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> is </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">   </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">operations and instructions</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">returned_value</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If a placeholder is needed, the instruction <code>skip</code> leaves the state unchanged.  The rationale for <code>skip</code> instead of a truly empty block is that it prevents you from writing an empty block by mistake.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">parameters</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">return_type</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> is </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">   skip</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">returned_value</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="blockless-functions"></a>Blockless functions<a class="hash-link" href="#blockless-functions" title="Direct link to heading">#</a></h5><p>Functions containing all of their logic into a single expression can be defined without a block. The add function above can be re-written as a blockless function:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">add</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> a</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> int</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> b </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> int</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int is a </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> b</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For more details about functions, see  <a href="https://ligolang.org/docs/language-basics/functions" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/language-basics/functions</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dispatching-the-control-flow-in-the-main-function"></a>Dispatching the control flow in the main function<a class="hash-link" href="#dispatching-the-control-flow-in-the-main-function" title="Direct link to heading">#</a></h4><p>In LIGO, the design pattern is to have one main function called <code>main</code>, that dispatches the control flow according to its parameters. The functions called-for for those actions are called entrypoints.</p><p>As an analogy, in the C programming language, the <code>main</code> function is the unique main function and any function called from it would be an entrypoint.</p><p>The parameter of the contract is then a variant type (described below), and, depending on the constructors of that type, different functions in the contract are called. In other terms, the unique main function dispatches the control flow depending on a pattern matching the contract parameter.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="variant-type"></a>Variant type<a class="hash-link" href="#variant-type" title="Direct link to heading">#</a></h5><p>A variant type is a user-defined, or a built-in type (in case of options) that defines a type by cases. A number of cases are defined in the type definition. The value of a variable of this type must be included in these cases. The simplest variant type is equivalent to the enumerated types found in Java, C++, JavaScript etc.</p><p>Here is how we define a bit as being either 1 or 0 (and nothing else):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type bit is </span><span class="token maybe-class-name">One</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">Zero</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> closed_switch </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bit </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">One</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> open_switch </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bit </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Zero</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Entrypoints are defined within a variant type:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type entrypoints is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">firstEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">firstEntrypointParameterType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">secondEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">secondEntrypointParameterType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(0, 92, 197)">...</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">nthEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">nthEntrypointParameterType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pattern-matching-variant-type-handling"></a>Pattern Matching (Variant type handling)<a class="hash-link" href="#pattern-matching-variant-type-handling" title="Direct link to heading">#</a></h5><p>Pattern matching is similar to the <code>switch</code> construct in Javascript, and can be used to route the program&#x27;s control flow based on the value of a variant. Consider for example the definition of a power switch that turns on/off a light.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type bit is </span><span class="token maybe-class-name">One</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">Zero</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">power_switch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> b </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> bit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bit is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> b </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token maybe-class-name">One</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">Zero</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">Zero</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">One</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The control is performed this way :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type entrypoints is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">firstEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">firstEntrypointParameterType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">secondEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">secondEntrypointParameterType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(0, 92, 197)">...</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">nthEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">nthEntrypointParameterType</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> entrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">firstEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">firstEntrypointFunctionName</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">secondEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">secondEntrypointFunctionName</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(0, 92, 197)">...</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">nthEntrypoint</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">nthEntrypointFunctionName</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="customizing-the-raffle-storage"></a>Customizing the Raffle storage<a class="hash-link" href="#customizing-the-raffle-storage" title="Direct link to heading">#</a></h3><p>The first entrypoint of the Raffle smart contract illustrates the basics of PascaLIGO, covered above.</p><p>Before coding the logic of the first action (opening a raffle session), the storage has to be modified to hold such a raffle. The contract needs an <strong>administrator</strong>: he will launch a raffle session, with a <strong>description</strong>. When the raffle is <strong>opened</strong>, it should be clearly noted in the storage. This raffle will need a <strong>reward</strong> and will be ongoing for a given <strong>time</strong>.</p><p>So, five pieces of information are needed:</p><ul><li>the raffle administrator</li><li>a description of the raffle</li><li>is the raffle opened?</li><li>the reward in tz</li><li>the raffle end date.</li></ul><blockquote><p>What would be the types for each piece of information?</p></blockquote><p>For each piece of information, the corresponding type is:</p><ul><li>raffle administrator: address</li><li>raffle description: string</li><li>raffle opened? : boolean</li><li>reward: tez</li><li>raffle end date: timestamp</li></ul><p>So far, the storage was empty, thanks to the <code>unit</code> type. The storage now needs to hold five pieces of information, of different types. Several values can be held in a <code>map</code>, but they must have the same type. Besides, <code>map</code> is not meant to keep the same number of elements.</p><p>The correct way to define a storage is to use the <code>record</code> type.</p><blockquote><p>Modify the storage smart contract to hold the 5 pieces of information, defined <a href="#modifying-the-storage">at the beginning of this part</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creating-a-raffle-session-entrypoint-definition"></a>Creating a raffle session: entrypoint definition<a class="hash-link" href="#creating-a-raffle-session-entrypoint-definition" title="Direct link to heading">#</a></h3><p>The contract storage can now hold a raffle session. The contract has to provide the users with a way of creating a raffle session. To do that, it needs an entrypoint that perform such an action: this new entrypoint should be named &quot;OpenRaffle&quot; and would allow the administrator to open a raffle.</p><p>So far, there is no entrypoint into this smart contract:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is unit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Adding the OpenRaffle entrypoint means defining the raffle entrypoint as a variant:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is </span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> unit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>raffleEntrypoints is now a variant: OpenRaffle (because of <code>of unit</code>) does not expect any argument.</p><p>In order to be exposed, OpenRaffle needs to be handled in a pattern matching, in the main function:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain">  </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><blockquote><p>Notice that the contract <strong>parameter</strong> (<em>raffleEntrypoints</em> variant) is requiring no parameter (<code>unit</code>).
For now, this smart contract only has a single default entrypoint with no argument.
The <em>storage</em> type is used as the second parameter of the <em>main</em> function. </p></blockquote><p>The smart contract now looks like (and is compiling):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is </span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> unit</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type returnType is </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Despite the definition of a more complex storage, the execution of the smart contract still does nothing. The smart contract should at least require some parameters and update its storage (thanks to the logic implementation).</p><p>To open a raffle, several pieces of information have to be sent: the reward, the closing date, and a raffle description.
Let&#x27;s define a type for these parameters:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type openRaffleParameter is tez </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>It is declared as a tuple:</p><ul><li>tez: the amount of the reward</li><li>timestamp: closing date</li><li>option(string): an optional description</li></ul><p>The OpenRaffle entrypoint must expect these parameters:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type openRaffleParameter is tez </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is </span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> openRaffleParameter</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Finally, the parameters must be added in the control flow in the main function:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type openRaffleParameter is tez </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is </span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> openRaffleParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type returnType is </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">OpenRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>It outputs a Michelson code, which does nothing, but there is a slight change in the parameter section:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">{ parameter (pair (pair mutez timestamp) (option string)) ;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  storage int ;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  code { CDR ; NIL operation ; PAIR } }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The openRaffleParameter is expected in the parameter section.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-the-openraffle-logic"></a>Adding the OpenRaffle logic<a class="hash-link" href="#adding-the-openraffle-logic" title="Direct link to heading">#</a></h3><p>The last step is to implement the logic of this entrypoint, in a function, which will update the storage.</p><p>Let&#x27;s create an empty function. This function expects the three needed parameters, and returns the standard list of operations and the updated store:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"> skip </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The first step is to check if the entrypoint is called by the administrator. If not, it should raise an exception. The check is performed by the association of an <code>if</code> condition and a <code>failwith</code>. The address calling the entrypoint should match the address in the storage. It is called access control:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;administrator not recognized&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        skip</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>A second check has to be performed: a raffle cannot be opened if the previous one has not yet closed. A boolean gives this piece of information in the storage: raffle_is_open</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            skip</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>A third check is performed on the reward: the funds sent must match the raffle reward.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> jackpot_amount then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The administrator does not own enough tz.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            skip</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>One final check is performed on the raffle closing date: the raffle should last at least a week.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> jackpot_amount then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The administrator does not own enough tz.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> seven_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token number">86400</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> in_7_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> seven_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> is_close_date_not_valid </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> in_7_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> is_close_date_not_valid then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            skip</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The logic is finally implemented. For this entrypoint, the only thing to do, is to store the pieces of information about the raffle: the reward, the closing date, the raffle description.  In addition, the storage should indicate that there&#x27;s an ongoing raffle. The storage needs to be updated with these pieces of information. </p><blockquote><p>Take a look at how the description is added to the storage (it is an <code>option</code>).</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> jackpot_amount then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The administrator does not own enough tz.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> seven_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token number">86400</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> in_7_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> seven_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> is_close_date_not_valid </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> in_7_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> is_close_date_not_valid then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> jackpot_amount</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">True</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> description </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">              </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">description</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain">skip</span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            end</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><blockquote><p>Keep in mind:</p><ul><li>to check entrypoint inputs as much as possible</li><li>that comparisons and mathematical operations are carried out the same way for any type (int, tez, timestamp...)</li><li>the storage is used and updated in an entrypoint</li></ul></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="smart-contract-development-buy-ticket-entrypoint"></a>Smart Contract development: Buy ticket entrypoint<a class="hash-link" href="#smart-contract-development-buy-ticket-entrypoint" title="Direct link to heading">#</a></h2><blockquote><p>LIGO concepts used in this part: with this second entrypoint, we will need to register players and map a raffle ticket to each player. Thus, we will learn how to use collections.
It will also be the opportunity for you to use again functions and performs checks</p></blockquote><p>The second entrypoint can be freely called by everyone who wants to buy a ticket. In this use case, each address can only buy one ticket, which costs 1 tz.</p><p>Two additional pieces of information have to be kept:</p><ol><li>who is taking part in the raffle</li><li>who owns a ticket</li></ol><p>The storage has to be modified. Collections are going to come in handy for the modification of the storage</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ligo-concepts-used-in-this-part-collections"></a>LIGO concepts used in this part: collections<a class="hash-link" href="#ligo-concepts-used-in-this-part-collections" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="lists"></a>Lists<a class="hash-link" href="#lists" title="Direct link to heading">#</a></h4><p>Lists are <strong>linear collections of elements of the same type</strong>.
Linear means that, in order to reach an element in a list, all the elements before have to be browsed (sequential access). Elements can be repeated, as only their order in the collection matters. The first element is called the <code>head</code>, and the sub-list after the head is called the <code>tail</code>.</p><p>Lists are used for returning operations from a smart contract&#x27;s main function and to store the same values several times in a collection</p><p>For more information, see <a href="https://ligolang.org/docs/reference/list-reference" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/reference/list-reference</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sets"></a>Sets<a class="hash-link" href="#sets" title="Direct link to heading">#</a></h4><p><em>Sets</em> are <strong>unordered collections of values of the same type</strong>, like lists are ordered collections.
Like the mathematical <em>sets</em> and <em>lists</em>, <em>sets</em> can be empty and, if not, elements of <em>sets</em> in LIGO are unique, even tho they can be repeated in a <em>list</em>.</p><p>For more information, see <a href="https://ligolang.org/docs/reference/set-reference" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/reference/set-reference</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="maps"></a>Maps<a class="hash-link" href="#maps" title="Direct link to heading">#</a></h4><p>A <em>Map</em> is a data structure which associates a value to a key, thus creating a key-value binding. All keys have the same type and all values have the same type.
An additional requirement is that the type of the keys must be comparable.</p><blockquote><p>Maps load their entries into the environment,
which is fine for small maps,
but for maps holding millions of entries,
the cost of loading them would be too expensive.
For this we use <code>big_maps</code>. Their syntax is the same as for regular maps.</p></blockquote><p>For more information, see <a href="https://ligolang.org/docs/language-basics/maps-records#maps" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/language-basics/maps-records#maps</a> and <a href="https://ligolang.org/docs/language-basics/maps-records#big-maps" target="_blank" rel="noopener noreferrer">https://ligolang.org/docs/language-basics/maps-records#big-maps</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="customizing-the-raffle-storage-1"></a>Customizing the Raffle storage<a class="hash-link" href="#customizing-the-raffle-storage-1" title="Direct link to heading">#</a></h3><p>Thanks to these collections, the second entrypoint of the Raffle smart contract can be implemented. A list of participants must be kept, as well as the ticket/owner pair.</p><p>Two new pieces of information will be stored in the contract storage.</p><blockquote><p>What collection should be used for:</p><ol><li>the participants (who can only buy one ticket)?</li><li>the tickets and their owner?</li></ol></blockquote><p>For the first point, two collections could be used: a list and a set. Since the participants can only buy one ticket, a set is the right choice (since each element cannot appear twice).</p><p>For the second point, each ticket should be mapped to its owner. The number of participants is not limited: there might be millions of them. So, a big map seems the right choice.</p><p>The set of participants should a have set of addresses, while the big map should map a ticket id (a nat) to an address. The new storage is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">set</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    sold_tickets </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">big_map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-the-buyticket-entrypoint"></a>Adding the BuyTicket entrypoint<a class="hash-link" href="#adding-the-buyticket-entrypoint" title="Direct link to heading">#</a></h3><p>The smart contract needs to expose another entrypoint. The method is the same as the one detailed for the first entrypoint:</p><ol><li>Define the type parameter. This type should be <code>unit</code>, since the buyer does not get to choose the ticket id:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type buyTicketParameter is unit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li>Adding the entrypoint in the variant:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> openRaffleParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">BuyTicket</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> buyTicketParameter</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>Handling the new entrypoint in the control flow:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">OpenRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">BuyTicket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementing-the-buyticket-logic"></a>Implementing the BuyTicket logic<a class="hash-link" href="#implementing-the-buyticket-logic" title="Direct link to heading">#</a></h3><p>The last step is to implement the logic of this entrypoint.  Just as for the first entrypoint, this logic will be implemented in a function, buy_ticket:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"> skip </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Two pieces of information have to be checked:</p><ol><li>is the buyer sending enough funds?</li><li>has the buyer not already bought a ticket?</li></ol><p>For the first point, this is the same check that is done for the first entrypoint. Checking if an address is calling the entrypoint for the first time (= a buyer cannot buy more than one ticket) means checking if the calling address is already in the payers <code>set</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_price </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> current_player </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sender</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> ticket_price then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The sender does not own enough tz to buy a ticket.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> contains current_player then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Each player can participate only once.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            skip</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Once these two checks have been performed, the buyer can receive a ticket. To do that, the entrypoint needs to:</p><ol><li>register the address as a participant: the address must be added into the payers set from the storage.</li><li>create a raffle ticket id. Since each participant can only buy a single ticket, the size of the participants set gives the new ticket id.</li><li>associate the ticket with its owner: the new ticket id will be a map to the buyer in the sold_tickets big_map.</li></ol><p>These three steps use the methods described in the collections section.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_price </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> current_player </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sender</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> ticket_price then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The sender does not own enough tz to buy a ticket.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> contains current_player then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Each player can participate only once.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">add</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">current_player</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> current_player</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The contract now is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type openRaffleParameter is tez </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type buyTicketParameter is unit</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> openRaffleParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">BuyTicket</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> buyTicketParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">set</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    sold_tickets </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">big_map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type returnType is </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> jackpot_amount then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The administrator does not own enough tz.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> seven_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token number">86400</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> in_7_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> seven_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> is_close_date_not_valid </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> in_7_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> is_close_date_not_valid then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> jackpot_amount</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">True</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> description </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">              </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">description</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain">skip</span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            end</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_price </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> current_player </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sender</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> ticket_price then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The sender does not own enough tz to buy a ticket.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> contains current_player then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Each player can participate only once.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">add</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">current_player</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> current_player</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">OpenRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">BuyTicket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="smart-contract-development-close-raffle-entrypoint"></a>Smart Contract development: Close raffle entrypoint<a class="hash-link" href="#smart-contract-development-close-raffle-entrypoint" title="Direct link to heading">#</a></h2><blockquote><p>LIGO concepts used in this part: with this last entrypoint, you will learn how to use transactions in order to send the reward to the winner. In addition, &gt; this will be the opportunity to warn you about some limitations of the language and to manipulate a little more collections.</p></blockquote><p>The last step is therefore to close the raffle, pick a winner and send the reward. This last entrypoint will show how to send a transaction from the contract and some collections manipulations</p><p>Five steps are required:</p><ol><li>Check that the calling address is the administrator</li><li>Check that the closing date has been reached and that the raffle is still open</li><li>Pick a winner</li><li>Send the reward to the winner</li><li>Reset the storage</li></ol><p>New pieces of information won&#x27;t be stored: as the storage is not expected to be modified. However, the third step raises a problem: how should the winner be picked?</p><ol><li>the administrator chooses the winner when calling this entrypoint:
participants are likely not to buy a ticket if the administrator can choose the winner himself</li><li>the winner is therefore randomly chosen when calling this entrypoint</li><li>the winner is chosen at the beginning by the administrator, but this piece of information is only revealed at the end of the raffle.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ligo-concepts-used-in-this-part-transactions"></a>LIGO concepts used in this part: Transactions<a class="hash-link" href="#ligo-concepts-used-in-this-part-transactions" title="Direct link to heading">#</a></h3><p>You can transfer tez to an account, and invoke a function from another smart contract.
For this, use :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">transaction</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">parameter</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">mutez</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain">contract</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>where:</p><ul><li><strong>parameter</strong> is the entrypoint of another contract,
or use <code>unit</code> if you are transferring to a wallet address,</li><li><strong>mutez</strong> is the amount to transfer,</li><li><strong>contract</strong> is the contract interface of the targeted contract.
It can be retrieved (with <code>Tezos.get_contract_opt</code> built-in function) from the address of the other contract or the wallet.</li></ul><p>Here&#x27;s an example of retrieving the contract interface from the <em>winner</em> <code>address</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> receiver </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">get_contract_opt</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">winner</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> c</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner contract not found.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> op </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> operation </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">transaction</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">jackpot</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> receiver</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Notice that the <code>Tezos.get_contract_opt</code> built-in function call will return an <code>option (contract (unit))</code>; thus allowing you to verify that the <em>winner</em> address is valid.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="about-randomness-in-smart-contracts"></a>About randomness in smart contracts<a class="hash-link" href="#about-randomness-in-smart-contracts" title="Direct link to heading">#</a></h3><p>The second option is not easily implemented in smart contracts. In any classical programming language (Python, C, Java...), a <strong>random</strong> function is directly usable from the standard API. With smart contracts, it is not possible.</p><p>Indeed, each smart contract execution has to be verified by any node in the network. However, how could this execution be verified if there is a random variable (one that would change every time)?</p><p>It might seem to be a good idea to use blockchain events (transaction hash, block timestamp...) as a source of randomness. However, in the end, bakers that create blocks could use this to their advantage.</p><p>The only solution seems to be the use of an external source of randomness or a secure cryptographic scheme. This topic goes well beyond this course.
For educational purpose, we will at first hardcode a ticket id winner. Then, the smart contract will be refactored, using the Bytes and Crypto modules.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-the-closeraffle-entrypoint"></a>Adding the CloseRaffle entrypoint<a class="hash-link" href="#adding-the-closeraffle-entrypoint" title="Direct link to heading">#</a></h3><p>The smart contract needs to expose this last entrypoint. The method is the same that has been detailed for the first and second entrypoint:</p><ol><li>Defining the type parameter. The type should be unit, since the administrator just needs to close the raffle without any other piece of information:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type closeRaffleParameter is unit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li>Adding the entrypoint in the variant:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> openRaffleParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">BuyTicket</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> buyTicketParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">CloseRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> closeRaffleParameter</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>Handling the new entrypoint in the control flow:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">OpenRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">BuyTicket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">CloseRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementing-the-closeraffle-logic"></a>Implementing the CloseRaffle logic<a class="hash-link" href="#implementing-the-closeraffle-logic" title="Direct link to heading">#</a></h3><p>Let&#x27;s create an empty function for this entrypoint:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operations</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>There is a slight difference with this entrypoint function: it has to return an operation. As a result, the list of operations won&#x27;t be empty and will be filled with one operation from within the function block.</p><p>The usual checks have to be implemented:</p><ol><li>only the administrator can close the raffle</li><li>the closing date must have been reached</li><li>the raffle must be open</li></ol><p>The winner will be picked thanks to a hardcoded value. However, even if there are only two participants, the raffle must have a winner. So, the number of participants must be known, so that the winning id matches an id ticket. For this, a modulo will be used: <code>hardcoded_number mod number_of_participants</code>
Of course, LIGO offers all the arithmetic operations (addition, subtraction, multiplication, division, mod). It won&#x27;t be detailed here, since it is exactly the same as other languages.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">close_date</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> number_of_players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> random_number </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">467n</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// hardcoded number</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> random_number mod number_of_players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// modulo expression</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operations</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The winning ticket is now chosen. The next step is to find its owner from the <code>sold_tickets big_map</code>. Since a key might not exist in a big map, fetching the value always return an option. This option is handled with pattern matching as show below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">close_date</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> number_of_players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> random_number </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">467n</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> random_number mod number_of_players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winner </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">winning_ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> a</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner address not found&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operations</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The winner has been found and now has to be rewarded. First, we need to check that this address does exist, then create a transaction which will be added to the operations list:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">close_date</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> number_of_players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> random_number </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">467n</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> random_number mod number_of_players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winner </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">winning_ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> a</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner address not found&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> receiver </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">get_contract_opt</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">winner</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> c</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner contract not found.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> op </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> operation </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">transaction</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">jackpot</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> receiver</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> list </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"> op</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operations</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The operations variable is no longer empty: this entrypoint does return a transaction, that will be sent by the smart contract.</p><p>Finally, the storage need to be reset. All the fields will be filled with empty values:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">close_date</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> number_of_players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> random_number </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">467n</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> random_number mod number_of_players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winner </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">winning_ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> a</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner address not found&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> receiver </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">get_contract_opt</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">winner</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> c</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner contract not found.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> op </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> operation </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">transaction</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">jackpot</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> receiver</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> list </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"> op</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain">tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token number">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          description </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;raffle is currently closed&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">False</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          players </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token keyword" style="color:#e3116c">set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          sold_tickets </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">big_map</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">big_map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operations</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="smart-contract-refactoring"></a>Smart contract refactoring<a class="hash-link" href="#smart-contract-refactoring" title="Direct link to heading">#</a></h2><p>Just as any other project, smart contracts will need refactoring during their development. In this part, the way the winner is chosen will be refactored. </p><p>Everyone, by reading the code, knows that the winning ticket is <code>407 mod Set.size(store.players)</code>. By tampering with the number of bought tickets, it is easy for everyone to get the winning ticket. In this part, we will make it harder to guess the winning ticker number. However, <strong>the method that will be used is not security compliant</strong>. This refactoring is meant for educational purposes: to show some advanced features of LIGO and is NOT to be used for any other purpose.</p><p>This part is an opportunity to put the emphasis on two modules: <code>Bytes</code> and <code>Crypto</code>.</p><p>The <code>Bytes</code> module handles binary format for serialization:
it converts Michelson structures into a binary format (and the reverse), concatenate two bytes...
You can find a full reference <a href="https://ligolang.org/docs/reference/bytes-reference/" target="_blank" rel="noopener noreferrer">here</a></p><p>The <code>Crypto</code> module performs a few basic operations: hashing and the signature verification.
You can find a full reference <a href="https://ligolang.org/docs/reference/crypto-reference" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="winner-selection-scheme"></a>Winner selection scheme<a class="hash-link" href="#winner-selection-scheme" title="Direct link to heading">#</a></h3><ol><li>The administrator will choose a large random number and keeps it to himself. </li><li>He hashes it and sends the hash when it calls the OpenRaffle entrypoint.</li><li>This hash is saved into the storage.</li><li>The administrator reveals his secret, random, large number, when calling the CloseRaffle entrypoint.</li><li>The smart contract hashes this number and checks that it matches the storage hash.
If it does, it uses this number to pick the winner just as before.
</li></ol><p>As warned above, this method is still rife with loopholes: </p><ul><li>the administrator knows the secret number and can tamper with the number of bought ticket to get the winning one</li><li>everyone can try to bruteforce the hash in order to find what number yielded this hash. This method just makes it a little harder to guess the number.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="refactoring-the-openraffle-entrypoint"></a>Refactoring the OpenRaffle entrypoint<a class="hash-link" href="#refactoring-the-openraffle-entrypoint" title="Direct link to heading">#</a></h3><p>The OpenRaffle entrypoint expects a new input: the number hash, that should be saved into the storage. Both the storage and entrypoint have to be modified.The method is very similar to what has been done before:</p><ol><li>Refactoring the storage: it must store a hash. According to the LIGO documentation, a hash has a <code>bytes</code> type:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">set</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    sold_tickets </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    winning_ticket_number_hash </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li>Adding the new input in the openRaffleParameter. The bytes type is added in the tuple:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type openRaffleParameter is tez </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> bytes</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>Updating the entrypoint function header:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> winning_ticket_number_hash </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> bytes</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="4"><li>Refactoring the entrypoint logic. For this change, the only thing to do is to save the hash in the storage:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> winning_ticket_number_hash </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> bytes</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> jackpot_amount then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The administrator does not own enough tz.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> seven_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token number">86400</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> in_7_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> seven_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> is_close_date_not_valid </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> in_7_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> is_close_date_not_valid then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> jackpot_amount</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">True</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          winning_ticket_number_hash </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> winning_ticket_number_hash</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// the hash is saved into the storage</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> description </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">description</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain">skip</span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          end</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="5"><li>The new input has to be processed in the control flow:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">OpenRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">BuyTicket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">CloseRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The smart contract now compiles:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">$ ligo compile-contract raffle.ligo main</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="refactoring-the-closeraffle-entrypoint"></a>Refactoring the CloseRaffle entrypoint<a class="hash-link" href="#refactoring-the-closeraffle-entrypoint" title="Direct link to heading">#</a></h3><p>The method is the same here.
So the step-by-step changes won&#x27;t be detailed: try to do this refactoring.
The ligo documentation will tell you how to hash a number and compare it.</p><p>Once you&#x27;re done with your smart contract refactoring, you can compare it with our suggested version:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type openRaffleParameter is tez </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> bytes</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type buyTicketParameter is unit</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type closeRaffleParameter is nat</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type raffleEntrypoints is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token maybe-class-name">OpenRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> openRaffleParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">BuyTicket</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> buyTicketParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">CloseRaffle</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"> closeRaffleParameter</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type storage is record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    admin </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    description </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">set</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    sold_tickets </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    winning_ticket_number_hash </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">type returnType is </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> storage</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> jackpot_amount </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> tez</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> close_date </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> timestamp</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> description </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> </span><span class="token parameter function" style="color:rgb(111, 66, 193)">option</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter">string</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> winning_ticket_number_hash </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> bytes</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> not store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> jackpot_amount then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The administrator does not own enough tz.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> seven_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> int </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">*</span><span class="token plain"> </span><span class="token number">86400</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> in_7_day </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> today </span><span class="token operator" style="color:rgb(0, 92, 197)">+</span><span class="token plain"> seven_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> is_close_date_not_valid </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bool </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> in_7_day</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> is_close_date_not_valid then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> jackpot_amount</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> close_date</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">True</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            winning_ticket_number_hash </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> winning_ticket_number_hash</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// the hash is saved into the storage</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> description </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">              </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">description</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain">skip</span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            end</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;A raffle is already open.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> param</span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> unit</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_price </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> tez </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> current_player </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sender</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">amount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> ticket_price then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The sender does not own enough tz to buy a ticket.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> contains current_player then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;Each player can participate only once.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">add</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">current_player</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> current_player</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nil </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> winning_ticket_number </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> nat</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">source</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">admin</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;administrator not recognized.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">raffle_is_open</span><span class="token plain"> then </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">now</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">&lt;</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">close_date</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle must remain open for at least 7 days.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_number_bytes </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bytes </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Bytes</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">pack</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">winning_ticket_number</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_number_hash </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> bytes </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Crypto</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">sha256</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">winning_ticket_number_bytes</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">if</span><span class="token plain"> winning_ticket_number_hash </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token operator" style="color:rgb(0, 92, 197)">/=</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">winning_ticket_number_hash</span><span class="token plain"> then </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;the hash does not match the hash of the winning ticket.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> number_of_players </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(227, 98, 9)">Set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">size</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winning_ticket_id </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> nat </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> winning_ticket_number mod number_of_players</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> winner </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">sold_tickets</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain">winning_ticket_id</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> a</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner address not found&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> receiver </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">get_contract_opt</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">winner</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">option</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">Some</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> c</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;winner contract not found.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">contract</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> op </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> operation </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Tezos</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token method function property-access" style="color:rgb(111, 66, 193)">transaction</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">unit</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token property-access" style="color:rgb(111, 66, 193)">jackpot</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> receiver</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> operations </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">list</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> list </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"> op</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            patch store </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> record </span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            jackpot </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain">tez</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            close_date </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token number">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            description </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;raffle is currently closed&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            raffle_is_open </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token maybe-class-name">False</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            players </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token keyword" style="color:#e3116c">set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">set</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            sold_tickets </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">map</span><span class="token punctuation" style="color:rgb(36, 41, 46)">[</span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">nat</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(36, 41, 46)">]</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span><span class="token function" style="color:rgb(111, 66, 193)">failwith</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token string">&quot;The raffle is closed.&quot;</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">operations</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token keyword" style="color:#e3116c">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">main</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> action </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> raffleEntrypoints</span><span class="token parameter punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#e3116c">const</span><span class="token parameter"> store </span><span class="token parameter operator" style="color:rgb(0, 92, 197)">:</span><span class="token parameter"> storage</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType is</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">block </span><span class="token punctuation" style="color:rgb(36, 41, 46)">{</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token keyword" style="color:#e3116c">const</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">:</span><span class="token plain"> returnType </span><span class="token operator" style="color:rgb(0, 92, 197)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">case</span><span class="token plain"> action </span><span class="token keyword" style="color:#e3116c">of</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">OpenRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">open_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">.</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">BuyTicket</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">buy_ticket</span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 92, 197)">|</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(111, 66, 193)">CloseRaffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 92, 197)">-</span><span class="token operator" style="color:rgb(0, 92, 197)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(111, 66, 193)">close_raffle</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(36, 41, 46)">(</span><span class="token plain">param</span><span class="token punctuation" style="color:rgb(36, 41, 46)">,</span><span class="token plain"> store</span><span class="token punctuation" style="color:rgb(36, 41, 46)">)</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    end</span><span class="token punctuation" style="color:rgb(36, 41, 46)">;</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain"></span><span class="token punctuation" style="color:rgb(36, 41, 46)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#e3116c">with</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#e3116c">return</span><span class="token plain"></span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Ligo is meant for smart contract development and always yields a Michelson code. The method for developing such smart contracts is pretty much always the same, and follows an order very close to the Michelson smart contract structure:</p><ol><li>the <strong>parameter</strong> (or entrypoints): the entrypoints are defined into a variant, a type is defined for the input entrypoints. </li><li>the <strong>storage</strong>: the storage is defined as a type. Usually, it is a record.</li><li>the <strong>code</strong>: the main function dispatches the actions using a pattern matching. The logic for each entrypoint is implemented in a function</li></ol><p>There needs to be a <strong>main</strong> function, which dispatches the actions of the smart contract.</p><p>LIGO syntax was designed to help developers build smart contracts by providing them with a syntax familiar to them: the main difference from other languages is the way the code is built, and a few technical limitations due to the particularities of using a blockchain (randomness for instance).</p><p>LIGO is only a part of the tools that make the experience of smart contract development easier for developers. Another part, introduced later in this module, is unit testing.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/octo-technology/OpenTezos/tree/main/docs/ligo/write-contracts-ligo.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-06-16T12:33:09.000Z" class="lastUpdatedDate_1WI_">6/16/2021</time> by <strong>frankhillard</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ligo/installation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Installation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ligo/language-basics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Language basics ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#raffle-smart-contract" class="table-of-contents__link">Raffle smart contract</a></li><li><a href="#prerequisites-for-smart-contracts-development" class="table-of-contents__link">Prerequisites for smart contracts development</a></li><li><a href="#smart-contract-initialization" class="table-of-contents__link">Smart contract initialization</a><ul><li><a href="#ligo-concepts-used-in-this-part" class="table-of-contents__link">LIGO concepts used in this part</a></li><li><a href="#raffle-storage-initialization" class="table-of-contents__link">Raffle storage initialization</a></li><li><a href="#raffle-parameter-initialization" class="table-of-contents__link">Raffle parameter initialization</a></li><li><a href="#raffle-code-definition" class="table-of-contents__link">Raffle code definition</a></li><li><a href="#summing-up" class="table-of-contents__link">Summing-up</a></li></ul></li><li><a href="#smart-contract-development--launch-raffle-entrypoint" class="table-of-contents__link">Smart Contract development¬†: launch raffle entrypoint</a><ul><li><a href="#ligo-concepts-used-in-this-part-1" class="table-of-contents__link">LIGO concepts used in this part</a></li><li><a href="#customizing-the-raffle-storage" class="table-of-contents__link">Customizing the Raffle storage</a></li><li><a href="#creating-a-raffle-session-entrypoint-definition" class="table-of-contents__link">Creating a raffle session: entrypoint definition</a></li><li><a href="#adding-the-openraffle-logic" class="table-of-contents__link">Adding the OpenRaffle logic</a></li></ul></li><li><a href="#smart-contract-development-buy-ticket-entrypoint" class="table-of-contents__link">Smart Contract development: Buy ticket entrypoint</a><ul><li><a href="#ligo-concepts-used-in-this-part-collections" class="table-of-contents__link">LIGO concepts used in this part: collections</a></li><li><a href="#customizing-the-raffle-storage-1" class="table-of-contents__link">Customizing the Raffle storage</a></li><li><a href="#adding-the-buyticket-entrypoint" class="table-of-contents__link">Adding the BuyTicket entrypoint</a></li><li><a href="#implementing-the-buyticket-logic" class="table-of-contents__link">Implementing the BuyTicket logic</a></li></ul></li><li><a href="#smart-contract-development-close-raffle-entrypoint" class="table-of-contents__link">Smart Contract development: Close raffle entrypoint</a><ul><li><a href="#ligo-concepts-used-in-this-part-transactions" class="table-of-contents__link">LIGO concepts used in this part: Transactions</a></li><li><a href="#about-randomness-in-smart-contracts" class="table-of-contents__link">About randomness in smart contracts</a></li><li><a href="#adding-the-closeraffle-entrypoint" class="table-of-contents__link">Adding the CloseRaffle entrypoint</a></li><li><a href="#implementing-the-closeraffle-logic" class="table-of-contents__link">Implementing the CloseRaffle logic</a></li></ul></li><li><a href="#smart-contract-refactoring" class="table-of-contents__link">Smart contract refactoring</a><ul><li><a href="#winner-selection-scheme" class="table-of-contents__link">Winner selection scheme</a></li><li><a href="#refactoring-the-openraffle-entrypoint" class="table-of-contents__link">Refactoring the OpenRaffle entrypoint</a></li><li><a href="#refactoring-the-closeraffle-entrypoint" class="table-of-contents__link">Refactoring the CloseRaffle entrypoint</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 OpenTezos.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.972b4ff9.js"></script>
<script src="/assets/js/main.6ca66676.js"></script>
</body>
</html>